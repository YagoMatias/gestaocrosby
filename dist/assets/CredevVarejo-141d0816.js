import{r as c,j as e,b as ee,L as se,c as te,s as I}from"./index-a2563983.js";import{u as ae}from"./useApiClient-0bf86fc1.js";import{l as oe,M as re}from"./ModalAuditoriaCredev-496592ef.js";import{C as L,a as U,b as F,c as B,d as O}from"./cards-fd94db0b.js";import{utils as w,write as ne}from"./xlsx-6ed613d4.js";import{F as le}from"./FileSaver.min-01e85130.js";import{m as ce}from"./ArrowClockwise.es-a22fa37a.js";import{s as ie}from"./CaretUp.es-b369da07.js";import{s as _}from"./CircleNotch.es-295869f9.js";import{m as $}from"./CurrencyDollar.es-0edca053.js";import{s as de}from"./Funnel.es-cd3339ac.js";import{f as me}from"./MagnifyingGlass.es-c5020417.js";import"./Modal-8500ef4b.js";import"./Button-3b4dd265.js";import"./ArrowDown.es-b2258871.js";import"./ArrowUp.es-3ccbaccd.js";const Se=()=>{const E=ae(),[i,C]=c.useState([]),[f,D]=c.useState(!1),[S,V]=c.useState(""),[p,q]=c.useState("CREDEV"),[N,X]=c.useState(""),[v,H]=c.useState([]),[J,k]=c.useState(!1),[g,R]=c.useState(null),[x,G]=c.useState({key:"nm_pessoa",direction:"asc"});c.useEffect(()=>{A(),K()},[]);const K=async()=>{try{console.log("🔍 Buscando empresas...");const s=await E.company.empresas();if(console.log("📊 Resposta completa da API empresas:",s),s.success&&s.data){console.log("📊 Estrutura do result.data:",s.data);let t=[];s.data.data&&Array.isArray(s.data.data)?(t=s.data.data,console.log("📊 Usando result.data.data:",t.length,"empresas")):Array.isArray(s.data)?(t=s.data,console.log("📊 Usando result.data diretamente:",t.length,"empresas")):console.log("📊 Estrutura não reconhecida. Propriedades disponíveis:",Object.keys(s.data)),console.log("📊 Amostra de empresasArray:",t.slice(0,3));const a=t.filter(o=>{const l=parseInt(o.cd_empresa);return!isNaN(l)&&l<5999});console.log("📊 Empresas após filtro < 5999:",a.length);const r=a.sort((o,l)=>parseInt(o.cd_empresa)-parseInt(l.cd_empresa));H(r),console.log("✅ Empresas carregadas no estado:",r.length),console.log("✅ Amostra das empresas ordenadas:",r.slice(0,5))}else console.log("❌ result.success:",s.success,"result.data:",s.data)}catch(s){console.error("❌ Erro ao buscar empresas:",s)}},A=async()=>{D(!0),V("");try{console.log("🔍 Buscando dados de CREDEV Varejo...");const s=await E.financial.credevVarejo();if(s.success){console.log("✅ Dados CREDEV Varejo recebidos:",{total:s.data.length,amostra:s.data.slice(0,2)}),C(s.data);const t=s.data.filter(a=>{if(p&&a.tp_documento&&a.tp_documento.toLowerCase()!==p.toLowerCase())return!1;const r=b(a.vl_saldo);let o=!0;a.dt_ultimocredito&&(o=new Date(a.dt_ultimocredito)>=new Date("2025-01-01"));const l=parseInt(a.cd_empresa),d=!isNaN(l)&&l<5999,n=parseInt(a.cd_pessoa),j=isNaN(n)||n!==56;return a.nm_pessoa&&r&&o&&d&&j})}else throw new Error(s.message||"Erro ao buscar dados")}catch(s){console.error("❌ Erro ao buscar dados CREDEV Varejo:",s),V("Erro ao carregar dados do servidor."),C([])}finally{D(!1)}},y=s=>{if(!s)return"-";const t=new Date(s);return isNaN(t)?"-":t.toLocaleDateString("pt-BR")},M=s=>s==null?"-":Number(s).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),b=s=>{if(s==null||s==="")return!1;let t;if(typeof s=="string"){const a=s.replace(/[^\d.,-]/g,"").replace(",",".");t=parseFloat(a)}else t=parseFloat(s);return!isNaN(t)&&t>.01},m=c.useMemo(()=>i.filter(s=>{if(p!=="TODOS"&&p&&s.tp_documento&&s.tp_documento.toLowerCase()!==p.toLowerCase()||!b(s.vl_saldo)||s.dt_ultimocredito&&new Date(s.dt_ultimocredito)<new Date("2025-01-01"))return!1;const t=parseInt(s.cd_empresa);if(isNaN(t)||t>=5999)return!1;const a=parseInt(s.cd_pessoa);return!(!isNaN(a)&&a===56||N&&s.cd_empresa&&!s.cd_empresa.toString().includes(N))}),[i,p,N]);c.useMemo(()=>[...new Set(i.filter(t=>{if(t.tp_documento!=="CREDEV")return!1;const a=b(t.vl_saldo);let r=!0;t.dt_ultimocredito&&(r=new Date(t.dt_ultimocredito)>=new Date("2025-01-01"));const o=parseInt(t.cd_empresa),l=!isNaN(o)&&o<5999,d=parseInt(t.cd_pessoa),n=isNaN(d)||d!==56;return a&&r&&l&&n}).map(t=>t.tp_documento).filter(Boolean))].sort(),[i]);const P=c.useMemo(()=>{console.log("🔄 Recalculando empresasDisponiveis..."),console.log("📊 Estado empresas:",v.length,"empresas"),console.log("📊 Estado dados:",i.length,"registros");const s=[...new Set(i.filter(a=>{const r=b(a.vl_saldo);let o=!0;a.dt_ultimocredito&&(o=new Date(a.dt_ultimocredito)>=new Date("2025-01-01"));const l=parseInt(a.cd_empresa),d=!isNaN(l)&&l<5999,n=parseInt(a.cd_pessoa),j=isNaN(n)||n!==56;return r&&o&&d&&j}).map(a=>a.cd_empresa).filter(Boolean))];console.log("📊 Códigos únicos encontrados nos dados:",s);const t=v.filter(a=>s.includes(a.cd_empresa.toString()));return console.log("📊 Empresas disponíveis para o filtro:",t.length),console.log("📊 Amostra empresas disponíveis:",t.slice(0,3)),t},[i,v]),u=s=>{let t="asc";x.key===s&&x.direction==="asc"&&(t="desc"),G({key:s,direction:t})},Q=s=>{s.nr_ctapes&&(R({nrCtaPes:s.nr_ctapes,dataUltimoMovimento:s.dt_ultimocredito}),k(!0))},W=()=>{k(!1),R(null)},h=s=>x.key!==s?e.jsx(I,{size:12,className:"ml-1 opacity-50"}):x.direction==="asc"?e.jsx(ie,{size:12,className:"ml-1"}):e.jsx(I,{size:12,className:"ml-1"}),z=s=>!s||s.length===0?s:[...s].sort((t,a)=>{const r=t[x.key],o=a[x.key];return x.direction==="asc"?r>o?1:r<o?-1:0:r<o?1:r>o?-1:0}),Y=()=>{if(m.length===0){alert("Não há dados para exportar!");return}try{const s=z(m).map((n,j)=>({Empresa:n.cd_empresa||"","CD Pessoa":n.cd_pessoa||"","NR CTAPES":n.nr_ctapes||"","Nome Cliente":n.nm_pessoa||"",Documento:n.tp_documento||"",Saldo:parseFloat(n.vl_saldo)||0,"Última Movimentação":y(n.dt_ultimocredito)==="--"?"":y(n.dt_ultimocredito)})),t=w.json_to_sheet(s),a=w.book_new();w.book_append_sheet(a,t,"CREDEV Varejo");const r=ne(a,{bookType:"xlsx",type:"array"}),o=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),d=`credev-varejo-${new Date().toLocaleDateString("pt-BR").replace(/\//g,"-")}.xlsx`;le.saveAs(o,d),console.log("✅ Excel exportado com sucesso:",d)}catch(s){console.error("❌ Erro ao exportar Excel:",s),alert("Erro ao exportar arquivo Excel. Tente novamente.")}};return e.jsxs("div",{className:"w-full max-w-6xl mx-auto flex flex-col items-stretch justify-start py-8 px-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-8",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-[#000638] mb-2",children:"CREDEV VAREJO"}),e.jsx("p",{className:"text-gray-600",children:"Saldos de CREDEV - Canal Varejo"})]})}),S&&e.jsx("div",{className:"mb-6 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded-lg",children:S}),e.jsx("div",{className:"mb-4",children:e.jsxs("form",{className:"flex flex-col bg-white p-3 rounded-lg shadow-lg w-full max-w-4xl mx-auto border border-[#000638]/10",children:[e.jsxs("div",{className:"mb-2",children:[e.jsxs("span",{className:"text-lg font-bold text-[#000638] flex items-center gap-1",children:[e.jsx(de,{size:18,weight:"bold"}),"Filtros"]}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"Configurações para análise CREDEV Varejo"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-1 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Tipo de Documento"}),e.jsxs("select",{value:p,onChange:s=>q(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] text-xs",children:[e.jsx("option",{value:"TODOS",children:"TODOS"}),e.jsx("option",{value:"CREDEV",children:"CREDEV"}),e.jsx("option",{value:"ADIANTAMENTO",children:"ADIANTAMENTO"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Empresa"}),console.log("🎯 empresasDisponiveis no render:",P),e.jsxs("select",{value:N,onChange:s=>X(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] text-xs",children:[e.jsx("option",{value:"",children:"Todas as Empresas"}),P.map(s=>(console.log("🔧 Renderizando empresa:",s),e.jsxs("option",{value:s.cd_empresa,children:[s.cd_empresa," - ",s.nm_grupoempresa]},s.cd_empresa)))]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:A,disabled:f,className:"flex items-center gap-1 bg-[#000638] text-white px-3 py-1 rounded-lg hover:bg-[#fe0000] disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors h-7 text-xs font-bold shadow-md tracking-wide uppercase",children:f?e.jsxs(e.Fragment,{children:[e.jsx(_,{size:10,className:"animate-spin"}),e.jsx("span",{children:"Carregando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:10}),e.jsx("span",{children:"Atualizar Dados"})]})})})]})]})}),m.length>0&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8 max-w-2xl mx-auto",children:[e.jsxs(L,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(U,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{size:18,className:"text-blue-600"}),e.jsx(F,{className:"text-sm font-bold text-blue-700",children:"Total de Registros"})]})}),e.jsxs(B,{className:"pt-0 px-4 pb-4",children:[e.jsx("div",{className:"text-lg font-extrabold text-blue-600 mb-1 break-words",children:f?e.jsx(_,{size:24,className:"animate-spin text-blue-600"}):m.length}),e.jsx(O,{className:"text-xs text-gray-500",children:"Registros CREDEV"})]})]}),e.jsxs(L,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(U,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{size:18,className:"text-green-600"}),e.jsx(F,{className:"text-sm font-bold text-green-700",children:"Saldo Total"})]})}),e.jsxs(B,{className:"pt-0 px-4 pb-4",children:[e.jsx("div",{className:"text-lg font-extrabold text-green-600 mb-1 break-words",children:f?e.jsx(_,{size:24,className:"animate-spin text-green-600"}):M(m.reduce((s,t)=>s+(Number(t.vl_saldo)||0),0))}),e.jsx(O,{className:"text-xs text-gray-500",children:"Soma de todos os saldos"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsx("h2",{className:"text-xl font-bold text-[#000638]",children:"Detalhamento CREDEV por Loja Varejo"}),m.length>0&&e.jsxs("button",{onClick:Y,className:"flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium text-sm",children:[e.jsx(oe,{size:16}),"BAIXAR EXCEL"]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-[#000638]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-left text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer ",onClick:()=>u("cd_empresa"),children:e.jsxs("div",{className:"flex items-center",children:["Empresa",h("cd_empresa")]})}),e.jsx("th",{className:"px-2 py-2 text-center text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer ",onClick:()=>u("cd_pessoa"),children:e.jsxs("div",{className:"flex items-center justify-center",children:["CD Pessoa",h("cd_pessoa")]})}),e.jsx("th",{className:"px-2 py-2 text-center text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer ",onClick:()=>u("nr_ctapes"),children:e.jsxs("div",{className:"flex items-center justify-center",children:["NR CTAPES",h("nr_ctapes")]})}),e.jsx("th",{className:"px-2 py-2 text-left text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer ",onClick:()=>u("nm_pessoa"),children:e.jsxs("div",{className:"flex items-center",children:["Nome Cliente",h("nm_pessoa")]})}),e.jsx("th",{className:"px-2 py-2 text-left text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer ",onClick:()=>u("tp_documento"),children:e.jsxs("div",{className:"flex items-center",children:["Documento",h("tp_documento")]})}),e.jsx("th",{className:"px-2 py-2 text-right text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer ",onClick:()=>u("vl_saldo"),children:e.jsxs("div",{className:"flex items-center justify-end",children:["Saldo",h("vl_saldo")]})}),e.jsx("th",{className:"px-2 py-2 text-center text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer ",onClick:()=>u("dt_ultimocredito"),children:e.jsxs("div",{className:"flex items-center justify-center",children:["Última Movimentação",h("dt_ultimocredito")]})})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(se,{size:"lg"}),e.jsx("span",{className:"text-gray-500",children:"Carregando dados..."})]})})}):m.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx($,{size:48,className:"text-gray-400"}),e.jsx("span",{className:"text-gray-500 font-medium",children:i.length===0?"Nenhum dado encontrado":"Nenhum registro corresponde aos filtros"}),e.jsx("span",{className:"text-gray-400 text-sm",children:i.length===0?"Não há registros de CREDEV":"Tente ajustar os filtros de busca"})]})})}):z(m).map((s,t)=>e.jsxs("tr",{className:"hover:bg-blue-50 cursor-pointer group",onClick:()=>Q(s),title:`Clique para ver detalhes de auditoria da conta ${s.nr_ctapes||"N/A"}`,children:[e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-gray-900",children:s.cd_empresa||"-"}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-center text-gray-900",children:s.cd_pessoa||"-"}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-center text-gray-900",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("span",{children:s.nr_ctapes||"-"}),e.jsx(me,{size:10,className:"text-blue-500 opacity-70"})]})}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-gray-900",children:s.nm_pessoa||"-"}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex px-1 py-0.5 text-[9px] font-semibold rounded-full ${s.tp_documento==="CREDEV"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.tp_documento||"-"})}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-right font-semibold",children:e.jsx("span",{className:Number(s.vl_saldo)>=0?"text-green-600":"text-red-600",children:M(s.vl_saldo)})}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-center text-gray-900",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(te,{size:12,className:"text-gray-400"}),y(s.dt_ultimocredito)]})})]},t))})]})})]}),e.jsx(re,{isOpen:J,onClose:W,nrCtaPes:g==null?void 0:g.nrCtaPes,dataUltimoMovimento:g==null?void 0:g.dataUltimoMovimento})]})};export{Se as default};
