import{j as a,r as p,f as F}from"./index-a2563983.js";import{R as S,B as V,b as L,X as T,Y as z,T as q,L as A,c as Q,P as G,a as D,C as H}from"./PieChart-2e5dc4ea.js";import{L as U,a as X}from"./LineChart-570f6699.js";const C=["#0088FE","#00C49F","#FFBB28","#FF8042","#8884D8","#82ca9d"],Z=({type:d,data:s,config:j})=>{var v,f,g;if(console.log("🎨 WidgetPreview - Recebendo:",{type:d,data:s,config:j}),!s||s.length===0)return a.jsx("div",{className:"flex items-center justify-center h-64 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300",children:a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-gray-500 text-lg font-medium",children:"Sem dados para exibir"}),a.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"Configure o widget para ver o preview"})]})});const i=(j==null?void 0:j.chartConfig)||{},E=i.chartType||d,l=i.xAxis,w=i.yAxis||[],u=i.groupBy;if(console.log("📊 Configuração do gráfico:",{chartType:E,xAxis:l,yAxis:w,groupBy:u,type:d}),d==="table"){const t=Object.keys(s[0]);return a.jsx("div",{className:"overflow-auto max-h-96 border border-gray-300 rounded-lg",children:a.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[a.jsx("thead",{className:"bg-gray-50 sticky top-0",children:a.jsx("tr",{children:t.map(c=>a.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:c},c))})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:s.map((c,h)=>a.jsx("tr",{className:"hover:bg-gray-50",children:t.map(o=>a.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 whitespace-nowrap",children:c[o]!==null&&c[o]!==void 0?c[o].toString():"-"},o))},h))})]})})}if(d==="bar"||d==="chart"||d==="graph"){const t=l||Object.keys(s[0])[0],c=w.length>0?w:Object.keys(s[0]).slice(1);return console.log("📊 Gráfico de Barras:",{xKey:t,yKeys:c,data:s.slice(0,2)}),a.jsx("div",{className:"h-80",children:a.jsx(S,{width:"100%",height:"100%",children:a.jsxs(V,{data:s,children:[a.jsx(L,{strokeDasharray:"3 3"}),a.jsx(T,{dataKey:t}),a.jsx(z,{}),a.jsx(q,{}),a.jsx(A,{}),c.map((h,o)=>a.jsx(Q,{dataKey:h,fill:C[o%C.length]},h))]})})})}if(d==="pie"||E==="pie"){console.log("🥧 Gráfico de Pizza - ANÁLISE DETALHADA:",{"Type recebido":d,ChartType:E,"Config completo":j,ChartConfig:i,"xAxis do chartConfig":i.xAxis,"yAxis do chartConfig":i.yAxis,"Dados recebidos (length)":s.length,"Primeiro item":s[0],"Chaves disponíveis":Object.keys(s[0]||{})});let t=i.xAxis||l||u,c=((v=i.yAxis)==null?void 0:v[0])||(w==null?void 0:w[0]);if(!t||!c){const h=Object.keys(s[0]);console.log("🔍 Tentando inferir chaves dos dados:",h);const o=h.filter(e=>{const n=s[0][e];return typeof n=="number"||!isNaN(Number(n))}),r=h.filter(e=>{const n=s[0][e];return typeof n=="string"||isNaN(Number(n))});t||(t=r[0]||h[0]),c||(c=o[0]||h[1]||h[0]),console.log("✨ Chaves inferidas:",{nameKey:t,valueKey:c,textKeys:r,numericKeys:o})}return console.log("🥧 Gráfico de Pizza - CHAVES FINAIS:",{"nameKey FINAL":t,"valueKey FINAL":c,"Valor do primeiro item [nameKey]":(f=s[0])==null?void 0:f[t],"Valor do primeiro item [valueKey]":(g=s[0])==null?void 0:g[c]}),!s[0]||s[0][t]===void 0||s[0][c]===void 0?(console.error("❌ Configuração inválida do gráfico de pizza:",{nameKey:t,valueKey:c,"data[0]":s[0],"Todas chaves":Object.keys(s[0]||{})}),a.jsx("div",{className:"flex items-center justify-center h-64 bg-red-50 rounded-lg border-2 border-red-200",children:a.jsxs("div",{className:"text-center p-4",children:[a.jsx("p",{className:"text-red-600 font-medium mb-2",children:"⚠️ Configuração Inválida"}),a.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Não foi possível determinar as colunas para o gráfico de pizza."}),a.jsxs("ul",{className:"text-sm text-gray-600 mt-2 text-left",children:[a.jsxs("li",{children:["• ",a.jsx("strong",{children:"Tentou usar para Nome:"})," ",t||"(nenhuma)"]}),a.jsxs("li",{children:["• ",a.jsx("strong",{children:"Tentou usar para Valor:"})," ",c||"(nenhuma)"]})]}),a.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Colunas disponíveis: ",Object.keys(s[0]||{}).join(", ")]}),a.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"Configure o eixo X e Y no passo 4 da criação do widget."})]})})):(console.log("✅ Renderizando gráfico de pizza com:",{nameKey:t,valueKey:c,"Total de items":s.length,"Amostra de dados":s.slice(0,3).map(h=>({[t]:h[t],[c]:h[c]}))}),a.jsx("div",{className:"h-[500px] w-full",children:a.jsx(S,{width:"100%",height:"100%",children:a.jsxs(G,{children:[a.jsx(D,{data:s,dataKey:c,nameKey:t,cx:"50%",cy:"45%",outerRadius:140,innerRadius:0,label:({name:h,value:o})=>`${h}: R$${o.toLocaleString()}`,labelLine:!1,children:s.map((h,o)=>a.jsx(H,{fill:C[o%C.length]},`cell-${o}`))}),a.jsx(q,{contentStyle:{fontSize:"12px",padding:"8px",borderRadius:"6px"}}),a.jsx(A,{verticalAlign:"bottom",height:80,wrapperStyle:{paddingTop:"30px",fontSize:"11px",lineHeight:"18px"},iconSize:10})]})})}))}if(d==="line"){const t=Object.keys(s[0]),c=t[0],h=t.slice(1);return a.jsx("div",{className:"h-80",children:a.jsx(S,{width:"100%",height:"100%",children:a.jsxs(U,{data:s,children:[a.jsx(L,{strokeDasharray:"3 3"}),a.jsx(T,{dataKey:c}),a.jsx(z,{}),a.jsx(q,{}),a.jsx(A,{}),h.map((o,r)=>a.jsx(X,{type:"monotone",dataKey:o,stroke:C[r%C.length],strokeWidth:2},o))]})})})}return null},W="https://apigestaocrosby-bw2v.onrender.com",I=()=>{const[d,s]=p.useState(!1),[j,i]=p.useState(null),E=p.useCallback(async()=>{s(!0),i(null);try{const g=await(await fetch(`${W}/api/widgets/views`)).json();if(!g.success)throw new Error(g.message||"Erro ao buscar views");return g.data||[]}catch(f){return console.error("Erro ao buscar views:",f),i(f.message),[]}finally{s(!1)}},[]),l=p.useCallback(async f=>{if(!f)return[];s(!0),i(null);try{const t=await(await fetch(`${W}/api/widgets/views/${f}/columns`)).json();if(!t.success)throw new Error(t.message||"Erro ao buscar colunas");return t.columns||[]}catch(g){return console.error("Erro ao buscar colunas:",g),i(g.message),[]}finally{s(!1)}},[]),w=p.useCallback(async f=>{s(!0),i(null);try{console.log("📤 Enviando query:",f);const g=await fetch(`${W}/api/widgets/query`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}),t=await g.json();if(console.log("📥 Resposta do servidor (status:",g.status,"):",t),!g.ok||!t.success){const c=t.message||t.error||"Erro ao executar query";throw console.error("❌ Erro da API:",c),new Error(c)}return{success:!0,data:t.data||[],count:t.count||0}}catch(g){return console.error("❌ Erro ao executar query:",g),i(g.message),{success:!1,data:[],error:g.message}}finally{s(!1)}},[]),u=p.useCallback(async(f,g)=>{s(!0),i(null);try{const c=await(await fetch(`${W}/api/widgets/validate-query`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({viewName:f,columns:g})})).json();if(!c.success)throw new Error(c.message||"Query inválida");return{success:!0,message:c.message}}catch(t){return console.error("Erro ao validar query:",t),i(t.message),{success:!1,error:t.message}}finally{s(!1)}},[]),v=p.useCallback(async f=>{const g={viewName:f.view,columns:f.selectedColumns,filters:f.filters.map(t=>({column:t.column,operator:t.operator,value:t.value,value2:t.value2,values:t.values})),aggregations:f.aggregations,orderBy:f.orderBy,limit:1e3};return await w(g)},[w]);return{loading:d,error:j,fetchViews:E,fetchViewColumns:l,executeQuery:w,validateQuery:u,executeWidgetQuery:v}},O=()=>{const[d,s]=p.useState(null),[j,i]=p.useState(!1),[E,l]=p.useState(null),w=p.useCallback(async u=>{i(!0),l(null);try{const v=await u();return s(v),v}catch(v){throw l(v.message),v}finally{i(!1)}},[]);return{data:d,loading:j,error:E,executeQuery:w,supabase:F}},ee=(d=null)=>{const{supabase:s}=O(),[j,i]=p.useState([]),[E,l]=p.useState(!1),[w,u]=p.useState(null),v=async(r=d)=>{if(!r)return[];l(!0),u(null);try{const{data:e,error:n}=await s.from("dashboards").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(n)throw n;const x=(e||[]).filter(y=>{var m;return((m=y.usuarios)==null?void 0:m.includes(r))||y.created_by===r});return i(x),x}catch(e){return console.error("Erro ao buscar dashboards:",e),u(e.message),[]}finally{l(!1)}},f=async r=>{l(!0),u(null);try{const{data:e,error:n}=await s.from("dashboards").select("*").eq("id",r).eq("is_active",!0).single();if(n)throw n;return e}catch(e){return console.error("Erro ao buscar dashboard:",e),u(e.message),null}finally{l(!1)}},g=async r=>{l(!0),u(null);try{const e=r.name||r.nome,n=r.description||r.descricao,x=r.user_ids||r.usuarios||[],{data:y,error:m}=await s.from("dashboards").insert([{nome:e,descricao:n,usuarios:x,created_by:d,is_active:!0}]).select().single();if(m)throw m;return i(b=>[y,...b]),{success:!0,data:y}}catch(e){return console.error("Erro ao criar dashboard:",e),u(e.message),{success:!1,error:e.message}}finally{l(!1)}},t=async(r,e)=>{l(!0),u(null);try{const n={};(e.name||e.nome)&&(n.nome=e.name||e.nome),(e.description||e.descricao)&&(n.descricao=e.description||e.descricao),(e.user_ids||e.usuarios)&&(n.usuarios=e.user_ids||e.usuarios);const{data:x,error:y}=await s.from("dashboards").update(n).eq("id",r).select().single();if(y)throw y;return i(m=>m.map(b=>b.id===r?x:b)),{success:!0,data:x}}catch(n){return console.error("Erro ao atualizar dashboard:",n),u(n.message),{success:!1,error:n.message}}finally{l(!1)}},c=async r=>{l(!0),u(null);try{const{error:e}=await s.from("dashboards").update({is_active:!1}).eq("id",r);if(e)throw e;return i(n=>n.filter(x=>x.id!==r)),{success:!0}}catch(e){return console.error("Erro ao deletar dashboard:",e),u(e.message),{success:!1,error:e.message}}finally{l(!1)}},h=async r=>{try{const{count:e,error:n}=await s.from("widgets").select("*",{count:"exact",head:!0}).eq("dashboard_id",r).eq("is_active",!0);if(n)throw n;return e||0}catch(e){return console.error("Erro ao contar widgets:",e),0}},o=async(r=d)=>{if(!r)return[];l(!0),u(null);try{const{data:e,error:n}=await s.from("dashboards").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(n)throw n;const x=(e||[]).filter(m=>{var b;return((b=m.usuarios)==null?void 0:b.includes(r))||m.created_by===r}),y=await Promise.all(x.map(async m=>{try{const{count:b}=await s.from("widgets").select("*",{count:"exact",head:!0}).eq("dashboard_id",m.id).eq("is_active",!0);return{...m,widget_count:b||0}}catch(b){return console.error(`Erro ao contar widgets do dashboard ${m.id}:`,b),{...m,widget_count:0}}}));return i(y),y}catch(e){return console.error("Erro ao buscar dashboards com widgets:",e),u(e.message),[]}finally{l(!1)}};return p.useEffect(()=>{d&&o(d)},[d]),{dashboards:j,loading:E,error:w,fetchDashboards:v,fetchUserDashboards:()=>o(d),getDashboardById:f,createDashboard:g,updateDashboard:t,deleteDashboard:c,getWidgetCount:h,fetchDashboardsWithWidgetCount:o,refetch:o}},re=(d=null)=>{const{supabase:s}=O(),[j,i]=p.useState([]),[E,l]=p.useState(!1),[w,u]=p.useState(null),v=async(o=d)=>{if(!o)return[];l(!0),u(null);try{const{data:r,error:e}=await s.from("widgets").select("*").eq("dashboard_id",o).eq("is_active",!0).order("created_at",{ascending:!1});if(e)throw e;return i(r||[]),r}catch(r){return console.error("Erro ao buscar widgets:",r),u(r.message),[]}finally{l(!1)}},f=async o=>{if(!o)return[];l(!0),u(null);try{console.log("🔍 [useWidgets] Buscando dashboards para userId:",o);const{data:r,error:e}=await s.from("dashboards").select("id, nome, usuarios, created_by").eq("is_active",!0);if(console.log("📊 [useWidgets] Dashboards retornados:",r),e)throw console.error("❌ [useWidgets] Erro ao buscar dashboards:",e),e;const n=r.map(b=>b.id);if(console.log("🎯 [useWidgets] Dashboard IDs:",n),n.length===0)return console.log("⚠️ [useWidgets] Nenhum dashboard encontrado"),i([]),[];console.log("🔍 [useWidgets] Buscando widgets para dashboards:",n);const{data:x,error:y}=await s.from("widgets").select(`
          *,
          dashboard:dashboards(id, nome, usuarios)
        `).in("dashboard_id",n).eq("is_active",!0).order("created_at",{ascending:!1});if(console.log("📦 [useWidgets] Widgets retornados:",x),y)throw console.error("❌ [useWidgets] Erro ao buscar widgets:",y),y;const m=x.map(b=>{var N;return{...b,dashboardName:((N=b.dashboard)==null?void 0:N.nome)||"Dashboard"}});return console.log("✅ [useWidgets] Widgets formatados:",m.length),i(m),m}catch(r){return console.error("❌ [useWidgets] Erro ao buscar widgets do usuário:",r),u(r.message),[]}finally{l(!1)}},g=async o=>{l(!0),u(null);try{const{data:r,error:e}=await s.from("widgets").select("*").eq("id",o).eq("is_active",!0).single();if(e)throw e;return r}catch(r){return console.error("Erro ao buscar widget:",r),u(r.message),null}finally{l(!1)}},t=async(o,r)=>{var e,n,x,y,m,b,N,k;l(!0),u(null);try{const _=o.dashboard_id||o.dashboardId,R=o.name||((e=o.config)==null?void 0:e.nome)||"Widget sem nome",P=o.view_name||((n=o.config)==null?void 0:n.viewName)||((x=o.config)==null?void 0:x.view)||"unknown_view",{data:B,error:K}=await s.from("widgets").insert([{dashboard_id:_,nome:R,view_name:P,config:{selectedColumns:((y=o.config)==null?void 0:y.selectedColumns)||o.selectedColumns||[],filters:((m=o.config)==null?void 0:m.filters)||o.filters||[],aggregations:((b=o.config)==null?void 0:b.aggregations)||o.aggregations||[],orderBy:((N=o.config)==null?void 0:N.orderBy)||o.orderBy||{},type:((k=o.config)==null?void 0:k.type)||o.type||"table"},created_by:r,is_active:!0}]).select().single();if(K)throw K;return i($=>[B,...$]),{success:!0,data:B}}catch(_){return console.error("Erro ao criar widget:",_),u(_.message),{success:!1,error:_.message}}finally{l(!1)}},c=async(o,r)=>{l(!0),u(null);try{const{data:e,error:n}=await s.from("widgets").update({nome:r.config.nome,view_name:r.config.view,config:{selectedColumns:r.config.selectedColumns,filters:r.config.filters,aggregations:r.config.aggregations,orderBy:r.config.orderBy,type:r.config.type}}).eq("id",o).select().single();if(n)throw n;return i(x=>x.map(y=>y.id===o?e:y)),{success:!0,data:e}}catch(e){return console.error("Erro ao atualizar widget:",e),u(e.message),{success:!1,error:e.message}}finally{l(!1)}},h=async o=>{l(!0),u(null);try{const{error:r}=await s.from("widgets").update({is_active:!1}).eq("id",o);if(r)throw r;return i(e=>e.filter(n=>n.id!==o)),{success:!0}}catch(r){return console.error("Erro ao deletar widget:",r),u(r.message),{success:!1,error:r.message}}finally{l(!1)}};return p.useEffect(()=>{d&&v(d)},[d]),{widgets:j,loading:E,error:w,fetchWidgets:v,fetchUserWidgets:f,getWidgetById:g,createWidget:t,updateWidget:c,deleteWidget:h,refetch:v}};export{Z as W,O as a,ee as b,re as c,I as u};
