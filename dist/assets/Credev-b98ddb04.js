import{r as l,j as e,o as Z,q as ee,L as te,c as se,s as P}from"./index-a2563983.js";import{u as ae}from"./useApiClient-0bf86fc1.js";import{F as re}from"./FiltroNomeFantasia-c5463908.js";import{l as oe,M as ne}from"./ModalAuditoriaCredev-496592ef.js";import{C as _,a as w,b as y,c as E,d as I}from"./cards-fd94db0b.js";import{utils as C,write as le}from"./xlsx-6ed613d4.js";import{F as ie}from"./FileSaver.min-01e85130.js";import{m as ce}from"./ArrowClockwise.es-a22fa37a.js";import{s as de}from"./CaretUp.es-b369da07.js";import{s as D}from"./CircleNotch.es-295869f9.js";import{m as L}from"./CurrencyDollar.es-0edca053.js";import{f as B}from"./MagnifyingGlass.es-c5020417.js";import"./Modal-8500ef4b.js";import"./Button-3b4dd265.js";import"./ArrowDown.es-b2258871.js";import"./ArrowUp.es-3ccbaccd.js";const Se=()=>{const U=ae(),[u,S]=l.useState([]),[h,k]=l.useState(!1),[F,R]=l.useState(""),[g,O]=l.useState("TODOS"),[N,q]=l.useState([]),[$,X]=l.useState([]),[H,A]=l.useState(!1),[f,M]=l.useState(null),[d,G]=l.useState({key:"nm_fantasia",direction:"asc"});l.useEffect(()=>{T()},[]);const T=async()=>{k(!0),R("");try{console.log("🔍 Buscando dados de CREDEV...");const t=await U.financial.credevAdiantamento();if(t.success){console.log("✅ Dados CREDEV recebidos:",{total:t.data.length,amostra:t.data.slice(0,2)}),S(t.data);const s=t.data.filter(a=>{if(!a.tp_documento||a.tp_documento!=="CREDEV"&&a.tp_documento!=="ADIANTAMENTO")return!1;const r=b(a.vl_saldo);let o=!0;a.dt_ultimocredito&&(o=new Date(a.dt_ultimocredito)>=new Date("2025-01-01"));const c=parseInt(a.cd_empresa),p=!isNaN(c)&&c<5999,n=parseInt(a.cd_pessoa),v=isNaN(n)||n!==56;return a.nm_fantasia&&r&&o&&p&&v}).map(a=>({cd_cliente:a.cd_pessoa||a.cd_cliente,nm_fantasia:a.nm_fantasia})).filter((a,r,o)=>r===o.findIndex(c=>c.nm_fantasia===a.nm_fantasia));X(s)}else throw new Error(t.message||"Erro ao buscar dados")}catch(t){console.error("❌ Erro ao buscar dados CREDEV:",t),R("Erro ao carregar dados do servidor."),S([])}finally{k(!1)}},j=t=>{if(!t)return"-";const s=new Date(t);return isNaN(s)?"-":s.toLocaleDateString("pt-BR")},z=t=>t==null?"-":Number(t).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),b=t=>{if(t==null||t==="")return!1;let s;if(typeof t=="string"){const a=t.replace(/[^\d.,-]/g,"").replace(",",".");s=parseFloat(a)}else s=parseFloat(t);return!isNaN(s)&&s>.01},i=l.useMemo(()=>u.filter(t=>{if(g&&g!=="TODOS"&&t.tp_documento!==g||!b(t.vl_saldo)||t.dt_ultimocredito&&new Date(t.dt_ultimocredito)<new Date("2025-01-01"))return!1;const s=parseInt(t.cd_empresa);if(isNaN(s)||s>=5999)return!1;const a=parseInt(t.cd_pessoa);if(!isNaN(a)&&a===56)return!1;if(N.length>0){const r=t.nm_fantasia;if(!N.some(c=>c.nm_fantasia===r))return!1}return!0}),[u,N,g]),J=t=>{q([...t])};l.useMemo(()=>[...new Set(u.filter(s=>{const a=b(s.vl_saldo);let r=!0;s.dt_ultimocredito&&(r=new Date(s.dt_ultimocredito)>=new Date("2025-01-01"));const o=parseInt(s.cd_empresa),c=!isNaN(o)&&o<5999,p=parseInt(s.cd_pessoa),n=isNaN(p)||p!==56;return a&&r&&c&&n}).map(s=>s.tp_documento).filter(Boolean))].sort(),[u]);const m=t=>{let s="asc";d.key===t&&d.direction==="asc"&&(s="desc"),G({key:t,direction:s})},K=t=>{t.nr_ctapes&&(M({nrCtaPes:t.nr_ctapes,dataUltimoMovimento:t.dt_ultimocredito}),A(!0))},Q=()=>{A(!1),M(null)},x=t=>d.key!==t?e.jsx(P,{size:12,className:"ml-1 opacity-50"}):d.direction==="asc"?e.jsx(de,{size:12,className:"ml-1"}):e.jsx(P,{size:12,className:"ml-1"}),V=t=>!t||t.length===0?t:[...t].sort((s,a)=>{let r,o;switch(d.key){case"cd_empresa":r=s.cd_empresa||"",o=a.cd_empresa||"";break;case"cd_pessoa":r=Number(s.cd_pessoa)||0,o=Number(a.cd_pessoa)||0;break;case"nr_ctapes":r=Number(s.nr_ctapes)||0,o=Number(a.nr_ctapes)||0;break;case"nm_fantasia":r=s.nm_fantasia||"",o=a.nm_fantasia||"";break;case"tp_documento":r=s.tp_documento||"",o=a.tp_documento||"";break;case"vl_saldo":r=Number(s.vl_saldo)||0,o=Number(a.vl_saldo)||0;break;case"dt_ultimocredito":r=s.dt_ultimocredito?new Date(s.dt_ultimocredito):new Date(0),o=a.dt_ultimocredito?new Date(a.dt_ultimocredito):new Date(0);break;default:r=s[d.key]||"",o=a[d.key]||""}return typeof r=="string"&&typeof o=="string"&&(r=r.toLowerCase(),o=o.toLowerCase()),d.direction==="asc"?r>o?1:r<o?-1:0:r<o?1:r>o?-1:0}),W=()=>{if(i.length===0){alert("Não há dados para exportar!");return}try{const t=V(i).map((n,v)=>({Empresa:n.cd_empresa||"","CD Pessoa":n.cd_pessoa||"","NR CTAPES":n.nr_ctapes||"","Nome Fantasia":n.nm_fantasia||"",Documento:n.tp_documento||"",Saldo:parseFloat(n.vl_saldo)||0,"Última Movimentação":j(n.dt_ultimocredito)==="--"?"":j(n.dt_ultimocredito)})),s=C.json_to_sheet(t),a=C.book_new();C.book_append_sheet(a,s,"CREDEV");const r=le(a,{bookType:"xlsx",type:"array"}),o=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),p=`credev-${new Date().toLocaleDateString("pt-BR").replace(/\//g,"-")}.xlsx`;ie.saveAs(o,p),console.log("✅ Excel exportado com sucesso:",p)}catch(t){console.error("❌ Erro ao exportar Excel:",t),alert("Erro ao exportar arquivo Excel. Tente novamente.")}};return e.jsxs("div",{className:"w-full max-w-6xl mx-auto flex flex-col items-stretch justify-start py-8 px-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-8",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-[#000638] mb-2",children:"CREDEV"}),e.jsx("p",{className:"text-gray-600",children:"Saldos de CREDEV"})]})}),F&&e.jsx("div",{className:"mb-6 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded-lg",children:F}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(B,{size:20,className:"text-[#000638]"}),e.jsx("h3",{className:"text-lg font-semibold text-[#000638]",children:"Filtros"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx("div",{children:e.jsx(re,{nomesFantasiaSelecionados:N,onSelectNomesFantasia:J,dadosNomesFantasia:$})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Tipo de Documento"}),e.jsxs("select",{value:g,onChange:t=>O(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 outline-none transition-colors",children:[e.jsx("option",{value:"TODOS",children:"TODOS"}),e.jsx("option",{value:"CREDEV",children:"CREDEV"}),e.jsx("option",{value:"ADIANTAMENTO",children:"ADIANTAMENTO"})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("button",{onClick:T,disabled:h,className:"flex items-center gap-2 bg-[#000638] text-white px-4 py-2 rounded-lg hover:bg-[#fe0000] transition h-10 text-sm font-bold shadow-md tracking-wide uppercase disabled:opacity-50",children:[e.jsx(ce,{size:18,weight:"bold",className:h?"animate-spin":""}),"Atualizar"]})})]})]}),i.length>0&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 max-w-7xl mx-auto",children:[e.jsxs(_,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(w,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{size:18,className:"text-blue-600"}),e.jsx(y,{className:"text-sm font-bold text-blue-700",children:"Total de Registros"})]})}),e.jsx(E,{className:"pt-0 px-4 pb-4",children:e.jsx("div",{className:"text-lg font-extrabold text-blue-600 mb-1 break-words",children:h?e.jsx(D,{size:24,className:"animate-spin text-blue-600"}):i.length})})]}),e.jsxs(_,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(w,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{size:18,className:"text-green-600"}),e.jsx(y,{className:"text-sm font-bold text-green-700",children:"Saldo Total"})]})}),e.jsxs(E,{className:"pt-0 px-4 pb-4",children:[e.jsx("div",{className:"text-lg font-extrabold text-green-600 mb-1 break-words",children:h?e.jsx(D,{size:24,className:"animate-spin text-green-600"}):z(i.reduce((t,s)=>t+(Number(s.vl_saldo)||0),0))}),e.jsx(I,{className:"text-xs text-gray-500",children:"Soma de todos os saldos"})]})]}),e.jsxs(_,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(w,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{size:18,className:"text-purple-600"}),e.jsx(y,{className:"text-sm font-bold text-purple-700",children:"Franquias"})]})}),e.jsxs(E,{className:"pt-0 px-4 pb-4",children:[e.jsx("div",{className:"text-lg font-extrabold text-purple-600 mb-1 break-words",children:h?e.jsx(D,{size:24,className:"animate-spin text-purple-600"}):new Set(i.map(t=>t.nm_fantasia)).size}),e.jsx(I,{className:"text-xs text-gray-500",children:"Franquias com saldo ativo"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsx("h2",{className:"text-xl font-bold text-[#000638]",children:"Detalhamento CREDEV por Franquia"}),i.length>0&&e.jsxs("button",{onClick:W,className:"flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium text-sm",children:[e.jsx(oe,{size:16}),"BAIXAR EXCEL"]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-[#000638]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-left text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer hover:bg-[#000638]/80 transition-colors",onClick:()=>m("cd_empresa"),children:e.jsxs("div",{className:"flex items-center",children:["Empresa",x("cd_empresa")]})}),e.jsx("th",{className:"px-2 py-2 text-center text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer hover:bg-[#000638]/80 transition-colors",onClick:()=>m("cd_pessoa"),children:e.jsxs("div",{className:"flex items-center justify-center",children:["CD Pessoa",x("cd_pessoa")]})}),e.jsx("th",{className:"px-2 py-2 text-center text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer hover:bg-[#000638]/80 transition-colors",onClick:()=>m("nr_ctapes"),children:e.jsxs("div",{className:"flex items-center justify-center",children:["NR CTAPES",x("nr_ctapes")]})}),e.jsx("th",{className:"px-2 py-2 text-left text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer hover:bg-[#000638]/80 transition-colors",onClick:()=>m("nm_fantasia"),children:e.jsxs("div",{className:"flex items-center",children:["Nome Fantasia",x("nm_fantasia")]})}),e.jsx("th",{className:"px-2 py-2 text-left text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer hover:bg-[#000638]/80 transition-colors",onClick:()=>m("tp_documento"),children:e.jsxs("div",{className:"flex items-center",children:["Documento",x("tp_documento")]})}),e.jsx("th",{className:"px-2 py-2 text-right text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer hover:bg-[#000638]/80 transition-colors",onClick:()=>m("vl_saldo"),children:e.jsxs("div",{className:"flex items-center justify-end",children:["Saldo",x("vl_saldo")]})}),e.jsx("th",{className:"px-2 py-2 text-center text-[10px] font-medium text-white uppercase tracking-wider cursor-pointer hover:bg-[#000638]/80 transition-colors",onClick:()=>m("dt_ultimocredito"),children:e.jsxs("div",{className:"flex items-center justify-center",children:["Última Movimentação",x("dt_ultimocredito")]})})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:h?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx(te,{size:"lg"}),e.jsx("span",{className:"text-gray-500",children:"Carregando dados..."})]})})}):i.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(L,{size:48,className:"text-gray-400"}),e.jsx("span",{className:"text-gray-500 font-medium",children:u.length===0?"Nenhum dado encontrado":"Nenhum registro corresponde aos filtros"}),e.jsx("span",{className:"text-gray-400 text-sm",children:u.length===0?"Não há registros de CREDEV":"Tente ajustar os filtros de busca"})]})})}):V(i).map((t,s)=>e.jsxs("tr",{className:"hover:bg-blue-50 hover:border-l-4 hover:border-l-blue-500 transition-all duration-200 cursor-pointer group",onClick:()=>K(t),title:`Clique para ver detalhes de auditoria da conta ${t.nr_ctapes||"N/A"}`,children:[e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-gray-900",children:t.cd_empresa||"-"}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-center text-gray-900",children:t.cd_pessoa||"-"}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-center text-gray-900",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("span",{children:t.nr_ctapes||"-"}),e.jsx(B,{size:10,className:"text-blue-500 opacity-70"})]})}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-gray-900",children:t.nm_fantasia||"-"}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex px-1 py-0.5 text-[9px] font-semibold rounded-full ${t.tp_documento==="CREDEV"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:t.tp_documento||"-"})}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-right font-semibold",children:e.jsx("span",{className:Number(t.vl_saldo)>=0?"text-green-600":"text-red-600",children:z(t.vl_saldo)})}),e.jsx("td",{className:"px-2 py-2 whitespace-nowrap text-[10px] text-center text-gray-900",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(se,{size:12,className:"text-gray-400"}),j(t.dt_ultimocredito)]})})]},s))})]})})]}),e.jsx(ne,{isOpen:H,onClose:Q,nrCtaPes:f==null?void 0:f.nrCtaPes,dataUltimoMovimento:f==null?void 0:f.dataUltimoMovimento})]})};export{Se as default};
