import{r as m,j as t,P as A,p as B}from"./index-a2563983.js";import{u as V}from"./useApiClient-0bf86fc1.js";const O=()=>{const F=V(),[S,C]=m.useState(!1),[D,N]=m.useState(""),[M,q]=m.useState([]),[n,h]=m.useState(1),b=20,[i,f]=m.useState({dt_inicio:"",dt_fim:"",empresas:[1,2,6,11,31,75,85,92,99],nr_transacao:"",cd_pessoa:"",cd_empresa:""});m.useEffect(()=>{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1).toISOString().split("T")[0],s=new Date(e.getFullYear(),e.getMonth()+1,0).toISOString().split("T")[0];f(r=>({...r,dt_inicio:a,dt_fim:s}))},[]);const L=async()=>{var e;try{C(!0),N("");const a={dt_inicio:i.dt_inicio,dt_fim:i.dt_fim,cd_classificacao:[4]};Array.isArray(i.empresas)&&i.empresas.length>0&&(a.cd_empresa=i.empresas),i.nr_transacao&&String(i.nr_transacao).trim()!==""&&(a.nr_transacao=String(i.nr_transacao).trim()),i.cd_pessoa&&String(i.cd_pessoa).trim()!==""&&(a.cd_pessoa=String(i.cd_pessoa).trim());const s=await F.sales.cmvfranquia(a);if(!s.success){N(s.message||"Falha ao carregar dados"),q([]);return}const r=Array.isArray((e=s==null?void 0:s.data)==null?void 0:e.data)?s.data.data:Array.isArray(s==null?void 0:s.data)?s.data:[];q(r),h(1)}catch(a){N("Erro ao buscar dados"),console.error(a)}finally{C(!1)}},x=e=>{if(e==null)return 0;if(typeof e=="number")return e;const a=Number(String(e).trim());return Number.isNaN(a)?0:a},u=e=>x(e).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),E=e=>{if(!e)return"";const a=typeof e=="string"?e:new Date(e).toISOString(),s=a.includes("T")?a.split("T")[0]:a,[r,o,d]=s.split("-");return!r||!o||!d?String(e):`${d}/${o}/${r}`},P=e=>x(e).toLocaleString("pt-BR",{minimumFractionDigits:0,maximumFractionDigits:3}),k=m.useMemo(()=>[{key:"nm_grupoempresa",header:"Empresa"},{key:"dt_transacao",header:"Referência",format:E},{key:"nr_transacao",header:"Nr Transação"},{key:"cd_pessoa",header:"Cd Pessoa"},{key:"nm_pessoa",header:"Nm Pessoa"},{key:"ds_nivel",header:"Descrição"},{key:"qt_faturado",header:"Qt Faturado",format:P},{key:"vl_unitliquido",header:"Líquido",format:u},{key:"vl_unitbruto",header:"Bruto",format:u},{key:"vl_produto",header:"CMV",format:u},{key:"vl_freterat",header:"Frete Rateado",format:u}],[]),l=m.useMemo(()=>{const e=String(i.nr_transacao||"").trim(),a=String(i.cd_pessoa||"").trim(),s=String(i.cd_empresa||"").trim();return!e&&!a&&!s?M:M.filter(r=>{let o=!0;return e&&(o=o&&String((r==null?void 0:r.nr_transacao)||"").includes(e)),a&&(o=o&&String((r==null?void 0:r.cd_pessoa)||"").includes(a)),s&&(o=o&&String((r==null?void 0:r.cd_grupoempresa)||(r==null?void 0:r.cd_empresa)||"").includes(s)),o})},[M,i.nr_transacao,i.cd_pessoa,i.cd_empresa]),g=m.useMemo(()=>{const e=Math.ceil((l.length||0)/b);return Math.max(1,e||1)},[l.length]),R=m.useMemo(()=>{const e=(n-1)*b,a=e+b;return l.slice(e,a)},[l,n]);m.useEffect(()=>{n>g?h(g):n<1&&h(1)},[n,g]);const c=m.useMemo(()=>{let e=0,a=0,s=0,r=0,o=0;for(const d of l){const y=x(d==null?void 0:d.qt_faturado)||1,v=x(d==null?void 0:d.vl_freterat)||0,j=x(d==null?void 0:d.vl_unitliquido)*y+v,_=x(d==null?void 0:d.vl_unitbruto)*y+v,p=x(d==null?void 0:d.vl_produto)*y;String(d==null?void 0:d.tp_operacao).trim()==="E"?(e-=Math.abs(j),a-=Math.abs(_),s+=Math.abs(j),r-=Math.abs(p)):(e+=j,a+=_,r+=p),o+=v}return{totalLiquido:e,totalBruto:a,totalDevolucoes:s,totalCMV:r,totalFrete:o}},[l]);return t.jsxs("div",{className:"w-full max-w-7xl mx-auto p-4",children:[t.jsx(A,{title:"CMV FRANQUIA",subtitle:"Consulta da rota /cmvfranquia (view materializada cmvfranquia)",icon:B,iconColor:"text-indigo-600"}),t.jsxs("div",{className:"bg-white rounded-lg shadow p-3 mb-4 border border-gray-200",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Data Início"}),t.jsx("input",{type:"date",value:i.dt_inicio,onChange:e=>f(a=>({...a,dt_inicio:e.target.value})),className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Data Fim"}),t.jsx("input",{type:"date",value:i.dt_fim,onChange:e=>f(a=>({...a,dt_fim:e.target.value})),className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Cd Empresa"}),t.jsx("input",{type:"text",value:i.cd_empresa,onChange:e=>f(a=>({...a,cd_empresa:e.target.value})),placeholder:"Ex.: 11",className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Nr Transação"}),t.jsx("input",{type:"text",value:i.nr_transacao,onChange:e=>f(a=>({...a,nr_transacao:e.target.value})),placeholder:"Ex.: 685924",className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Cd Pessoa"}),t.jsx("input",{type:"text",value:i.cd_pessoa,onChange:e=>f(a=>({...a,cd_pessoa:e.target.value})),placeholder:"Ex.: 19295",className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsx("div",{className:"flex items-end",children:t.jsx("button",{onClick:L,disabled:S||!i.dt_inicio||!i.dt_fim,className:"bg-indigo-600 text-white text-xs px-3 py-2 rounded hover:bg-indigo-700 disabled:opacity-50",children:S?"Buscando...":"Buscar"})})]}),D&&t.jsx("div",{className:"mt-2 text-xs text-red-600",children:D})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-8 gap-3 mb-4",children:[t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Receita Liq + Imp"}),t.jsx("div",{className:"text-lg font-semibold text-green-600",children:u(c.totalLiquido)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Receita Bruta"}),t.jsx("div",{className:"text-lg font-semibold text-blue-600",children:u(c.totalBruto)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Total de Devoluções"}),t.jsx("div",{className:"text-lg font-semibold text-red-600",children:u(c.totalDevolucoes)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Total CMV"}),t.jsx("div",{className:"text-lg font-semibold",children:u(c.totalCMV)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"CMV %"}),t.jsx("div",{className:"text-lg font-semibold",children:(()=>{const e=Math.abs(c.totalLiquido)||0;return e?`${(c.totalCMV/e*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}%`:"0,00%"})()})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Margem %"}),t.jsx("div",{className:"text-lg font-semibold",children:(()=>{const e=Math.abs(c.totalLiquido)||0;return e?`${((c.totalLiquido-c.totalCMV)/e*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}%`:"0,00%"})()})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Markup"}),t.jsx("div",{className:"text-lg font-semibold",children:(()=>{const e=Math.abs(c.totalCMV)||0;return e?`${(c.totalLiquido/e).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}x`:"—"})()})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Total Frete"}),t.jsx("div",{className:"text-lg font-semibold",children:u(c.totalFrete)})]})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsxs("div",{className:"text-xs text-gray-600 mb-2",children:["Registros: ",l.length,l.length>0&&t.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["Mostrando ",(n-1)*b+1,"-",Math.min(n*b,l.length)," ","de ",l.length]})]}),t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full text-xs border-collapse",children:[t.jsx("thead",{className:"bg-gray-100",children:t.jsx("tr",{children:k.map(e=>t.jsx("th",{className:"px-2 py-1 text-left font-semibold text-gray-700",children:e.header},e.key))})}),t.jsxs("tbody",{children:[R.map((e,a)=>t.jsx("tr",{className:a%2===0?"bg-white":"bg-gray-50",children:k.map(s=>{let r=s.key==="__perc"?void 0:e[s.key];const o=s.key==="vl_unitliquido"||s.key==="vl_unitbruto"||s.key==="vl_produto",d=String(e==null?void 0:e.tp_operacao).trim()==="E",y=x(e==null?void 0:e.qt_faturado)||1,v=x(e==null?void 0:e.vl_freterat)||0;if(o){let p;s.key==="vl_produto"?p=x(r)*y:p=x(r)*y+v,r=d?-Math.abs(p):p}const j=s.format?s.format(r,e):r??"",_=o&&d?" text-red-600":"";return t.jsx("td",{className:`px-2 py-1${_}`,children:j},s.key)})},a)),l.length===0&&t.jsx("tr",{children:t.jsx("td",{className:"px-2 py-4 text-center text-gray-500",colSpan:k.length,children:"Nenhum registro"})})]})]})}),l.length>b&&t.jsxs("div",{className:"mt-3 flex items-center justify-between text-xs",children:[t.jsxs("div",{children:[" ","Página ",n," de ",g," "]}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(1),disabled:n===1,children:"« Primeira"}),t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(e=>Math.max(1,e-1)),disabled:n===1,children:"‹ Anterior"}),t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(e=>Math.min(g,e+1)),disabled:n===g,children:"Próxima ›"}),t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(g),disabled:n===g,children:"Última »"})]})]})]})]})};export{O as default};
