import{R as ne,r as c,j as e,P as le,p as ie}from"./index-a2563983.js";import{F as de}from"./FiltroEmpresa-724027b5.js";import{u as ue}from"./useApiClient-0bf86fc1.js";const he=()=>{ne.useEffect(()=>{const t=document.createElement("style");return t.textContent=`
      .receita-table {
        border-collapse: collapse;
        width: 100%;
      }
      
      .receita-table th,
      .receita-table td {
        padding: 3px 4px !important;
        border-right: 1px solid #f3f4f6;
        word-wrap: break-word;
        white-space: normal;
        font-size: 9px;
        line-height: 1.2;
      }
      
      .receita-table th:last-child,
      .receita-table td:last-child {
        border-right: none;
      }
      
      .receita-table th {
        background-color: #000638;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 8px;
        letter-spacing: 0.05em;
      }
      
      .receita-table tbody tr:nth-child(odd) {
        background-color: white;
      }
      
      .receita-table tbody tr:nth-child(even) {
        background-color: #fafafa;
      }
      
      .receita-table tbody tr:hover {
        background-color: #f0f9ff;
        transition: background-color 0.2s ease;
      }
    `,document.head.appendChild(t),()=>{document.head.removeChild(t)}},[]);const C=ue(),[v,B]=c.useState([]),[_,Z]=c.useState(""),[b,tt]=c.useState(""),[O,P]=c.useState(!1),[et,J]=c.useState(""),[st,at]=c.useState(0),[rt,ot]=c.useState(0),[ct,nt]=c.useState(0),[lt,it]=c.useState(0),[dt,ut]=c.useState(0),[pt,mt]=c.useState(0),[xt,ht]=c.useState([]),Tt="v1",ft=50,kt=300,Ft=4,q=c.useRef(null),I=c.useRef(null),H=c.useRef(0),[bt,j]=c.useState(0),[Mt,gt]=c.useState(!1),[T,V]=c.useState(null),yt=c.useRef(!1),$=[{cd_empresa:"1"},{cd_empresa:"2"},{cd_empresa:"200"},{cd_empresa:"75"},{cd_empresa:"31"},{cd_empresa:"6"},{cd_empresa:"85"},{cd_empresa:"11"},{cd_empresa:"99"},{cd_empresa:"92"},{cd_empresa:"5"},{cd_empresa:"500"},{cd_empresa:"55"},{cd_empresa:"550"},{cd_empresa:"65"},{cd_empresa:"650"},{cd_empresa:"93"},{cd_empresa:"930"},{cd_empresa:"94"},{cd_empresa:"940"},{cd_empresa:"95"},{cd_empresa:"950"},{cd_empresa:"96"},{cd_empresa:"960"},{cd_empresa:"97"},{cd_empresa:"970"},{cd_empresa:"90"},{cd_empresa:"91"},{cd_empresa:"890"},{cd_empresa:"910"},{cd_empresa:"920"}],z=t=>new Date(t).toISOString().slice(0,10),Pt=t=>!t||!t.length?"default":t.map(a=>(a==null?void 0:a.cd_empresa)||a).sort().join(","),vt=(t,o,a)=>["receitaliquida",Tt,z(t||"1970-01-01"),z(o||"1970-01-01"),`emp:${Pt(a)}`].join("|"),Jt=t=>{try{return btoa(JSON.stringify(t))}catch{return JSON.stringify(t)}},Ht=t=>{try{return JSON.parse(atob(t))}catch{return JSON.parse(t)}},Vt=()=>{try{const t=Object.keys(localStorage).filter(o=>o.startsWith("receitaliquida|"));if(t.length>ft){const o=t.map(r=>({k:r,ts:JSON.parse(localStorage.getItem(r)||"{}").ts||0})).sort((r,n)=>r.ts-n.ts);o.slice(0,o.length-ft+5).forEach(r=>localStorage.removeItem(r.k))}}catch{}},$t=(t,o)=>{try{Vt();const a=Jt(o);localStorage.setItem(t,JSON.stringify({ts:Date.now(),data:a}))}catch{}},zt=t=>{try{const o=localStorage.getItem(t);if(!o)return null;const a=JSON.parse(o);return{ts:a.ts,data:Ht(a.data)}}catch{return null}},Ut=(t,o)=>Date.now()-t>o,Xt=t=>{const o=new Date(z(t||new Date)),a=new Date(new Date().toISOString().slice(0,10)),r=o>=a,n=new Date().getHours(),u=n>=8&&n<=18;return r?u?15*60*1e3:45*60*1e3:4*60*60*1e3},U=c.useCallback(t=>(Array.isArray(t)?t:[]).filter(r=>{const n=String(r.cd_classificacao??"").trim();return n==="1"||n==="3"||n==="2"||n==="4"||n===""}).filter((r,n,u)=>{const l=r.cd_pessoa,m=String(r.cd_classificacao??"").trim();return m==="3"?!0:m==="1"?!u.some(p=>p.cd_pessoa===l&&String(p.cd_classificacao??"").trim()==="3"):!0}),[]),A=c.useCallback((t,o)=>(t||[]).reduce((a,r)=>{const n=Number(r.qt_faturado)||1,u=(Number(r[o])||0)*n;return r.tp_operacao==="S"?a+u:r.tp_operacao==="E"?a-u:a},0),[]),E=c.useCallback((t,o,a)=>(t||[]).reduce((r,n)=>{const u=Number(n.qt_faturado)||1,l=(Number(n[o])||0)*u;return n.tp_operacao==="S"?r+l:a&&n.tp_operacao==="E"?r-l:r},0),[]),Yt=c.useCallback(async(t,o)=>{if(!t||t.length===0)return{byTransacao:{},totals:{icms:0,pis:0,cofins:0}};gt(!0);try{const r=[];for(let i=0;i<t.length;i+=500)r.push(t.slice(i,i+500));console.log(`🔍 Buscando impostos reais em ${r.length} lotes de até 500 transações cada`);const n=3,u=[];for(let i=0;i<r.length;i+=n){const x=r.slice(i,i+n).map(async y=>{const S=await C.sales.vlimposto({nr_transacao:y});return S.success&&S.data?S.data:(console.warn("Resposta inválida para lote:",S),[])});try{const y=await Promise.all(x);u.push(...y.flat())}catch(y){console.error(`Erro em lote ${i}-${i+n}:`,y)}const g=Math.round((i+n)/r.length*100);o&&o(Math.min(g,100))}const l={},m={icms:0,pis:0,cofins:0};for(const i of u){const p=String(i.nr_transacao),x=parseFloat(i.valorimposto||0)||0,g=Number(i.cd_imposto);l[p]||(l[p]={icms:0,pis:0,cofins:0}),g===1?(l[p].icms+=x,m.icms+=x):g===5?(l[p].cofins+=x,m.cofins+=x):g===6&&(l[p].pis+=x,m.pis+=x)}return console.log("✅ Impostos reais agregados:",{totals:m,sample:Object.entries(l).slice(0,2)}),{byTransacao:l,totals:m}}catch(a){throw console.error("Erro crítico ao buscar impostos:",a),a}finally{gt(!1)}},[C]),_t=c.useCallback(async()=>{if(J(""),!v.length||!_||!b||H.current>=Ft)return;I.current&&I.current.abort(),I.current=new AbortController,H.current++,P(!0),j(0),V(null);const t=vt(_,b,v),o=Xt(b);try{const a=zt(t);if(a&&!Ut(a.ts,o)){const s=a.data;at(s.totals.totalBruto||0),ot(s.totals.totalLiquido||0),nt(s.totals.totalIcms||0),it(s.totals.totalDesconto||0),ut(s.totals.totalPis||0),mt(s.totals.totalCofins||0),ht(s.rows||[]),P(!1),j(100),V({fromCache:!0,at:a.ts});return}const r=v.map(s=>s.cd_empresa||s),u=((s,d)=>{const L=[];for(let R=0;R<s.length;R+=d)L.push(s.slice(R,R+d));return L})(r,12),l=async s=>{const d=await Promise.allSettled(u.map(h=>s({dt_inicio:_,dt_fim:b,cd_empresa:h}))),R=d.filter(h=>h.status==="fulfilled").flatMap(h=>{var w;return Array.isArray((w=h.value)==null?void 0:w.data)?h.value.data:[]});return{success:!d.some(h=>h.status==="rejected"||h.value&&h.value.success===!1),data:R}},[m,i,p,x]=await Promise.all([l(C.sales.faturamento).then(s=>(j(d=>d+25),s)),l(C.sales.faturamentoRevenda).then(s=>(j(d=>d+25),s)),l(C.sales.faturamentoFranquia).then(s=>(j(d=>d+25),s)),l(C.sales.faturamentoMtm).then(s=>(j(d=>d+25),s))]);if(!m.success||!i.success||!p.success||!x.success)throw new Error("Falha em alguma rota");const g=Array.isArray(m.data)?m.data:[],y=Array.isArray(i.data)?i.data:[],S=Array.isArray(p.data)?p.data:[],k=Array.isArray(x.data)?x.data:[],Gt=[...g.filter(s=>s.tp_operacao==="S").map(s=>s.nr_transacao),...y.filter(s=>s.tp_operacao==="S").map(s=>s.nr_transacao),...S.filter(s=>s.tp_operacao==="S").map(s=>s.nr_transacao),...k.filter(s=>s.tp_operacao==="S").map(s=>s.nr_transacao)].filter((s,d,L)=>s&&L.indexOf(s)===d);let D;try{D=await Yt(Gt,s=>{j(80+s*.2)})}catch(s){console.error("Falha crítica ao buscar impostos reais:",s),J("Erro ao buscar dados de impostos. Verifique a conexão e tente novamente.");return}const Wt=E(g,"vl_unitbruto",!0),Kt=E(y,"vl_unitbruto",!0),Qt=E(S,"vl_unitbruto",!1),Zt=E(k,"vl_unitbruto",!1),X=Wt+Kt+Qt+Zt,te=A(U(y),"vl_unitliquido"),ee=E(g,"vl_unitliquido",!1),se=A(S,"vl_unitliquido"),ae=A(k,"vl_unitliquido"),Y=te+ee+se+ae,St=D.totals.icms,Nt=D.totals.pis,jt=D.totals.cofins,Rt=X-Y;at(X),ot(Y),nt(St),it(Rt),ut(Nt),mt(jt);const F=async(s,d,L={})=>{const{applyRev:R=!1,subtractEntries:Ct=!0,mode:h}=L,w=R?U(d):d,re=w.filter(f=>f.tp_operacao==="S").map(f=>String(f.nr_transacao)).filter((f,N,M)=>f&&M.indexOf(f)===N);let G=0,W=0,K=0;if(re.forEach(f=>{const N=D.byTransacao[f];N&&(G+=N.icms||0,W+=N.pis||0,K+=N.cofins||0)}),h==="varejo"){const f=E(w,"vl_unitbruto",!0),N=A(w,"vl_unitliquido"),M=f-N,It=G,Dt=W,Ot=K,ce=f-M-It-Dt-Ot;return{canal:s,bruto:f,desconto:M,vendasAposDesconto:N,icms:It,pis:Dt,cofins:Ot,receitaLiquida:ce}}const Q=A(w,"vl_unitbruto"),Et=E(w,"vl_unitliquido",Ct),Lt=G,At=Q-Et,Bt=W,qt=K,oe=Q-At-Lt-Bt-qt;return{canal:s,bruto:Q,desconto:At,vendasAposDesconto:Et,icms:Lt,pis:Bt,cofins:qt,receitaLiquida:oe}},wt=await Promise.all([F("Varejo",g,{mode:"varejo"}),F("Franquia",S,{subtractEntries:!0}),F("Multimarca",k,{subtractEntries:!0}),F("Revenda",y,{applyRev:!0,subtractEntries:!0})]);ht(wt),$t(t,{totals:{totalBruto:X,totalLiquido:Y,totalIcms:St,totalDesconto:Rt,totalPis:Nt,totalCofins:jt},rows:wt}),V({fromCache:!1,at:Date.now()}),j(100)}catch{J("Falha ao carregar receita líquida.")}finally{H.current--,P(!1)}},[v,_,b,C,U,A]);return c.useEffect(()=>()=>{q.current&&clearTimeout(q.current),I.current&&I.current.abort()},[]),c.useEffect(()=>{const t=new Date,o=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,0),r=localStorage.getItem("rl_dt_inicio"),n=localStorage.getItem("rl_dt_fim"),u=localStorage.getItem("rl_empresas");if(Z(r||o.toISOString().split("T")[0]),tt(n||a.toISOString().split("T")[0]),u)try{const l=JSON.parse(u);Array.isArray(l)&&l.length>0?B(l):B($)}catch{B($)}else B($);setTimeout(()=>{yt.current=!0},0)},[]),c.useEffect(()=>{try{localStorage.setItem("rl_dt_inicio",_||"")}catch{}},[_]),c.useEffect(()=>{try{localStorage.setItem("rl_dt_fim",b||"")}catch{}},[b]),c.useEffect(()=>{if(yt.current)try{localStorage.setItem("rl_empresas",JSON.stringify(v||[]))}catch{}},[v]),e.jsxs("div",{className:"w-full max-w-4xl mx-auto flex flex-col items-stretch justify-start py-3 px-2",children:[e.jsx(le,{title:"Receita Líquida",subtitle:"Análise detalhada da receita líquida por empresa e período",icon:ie,iconColor:"text-blue-600"}),e.jsx("div",{className:"mb-4",children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),q.current&&clearTimeout(q.current),q.current=setTimeout(()=>_t(),kt)},className:"flex flex-col bg-white p-3 rounded-lg shadow-md w-full max-w-4xl mx-auto border border-[#000638]/10",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[T&&e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full border border-gray-300 text-gray-700 bg-gray-100",children:[T.fromCache?"⚡ Cache":"🔄 Atualizado"," • ",T.at?new Date(T.at).toLocaleString("pt-BR"):""]}),e.jsx("button",{type:"button",disabled:O,onClick:()=>{try{const t=vt(_,b,v);localStorage.removeItem(t)}catch{}_t()},className:"text-xs px-3 py-1 rounded-md bg-[#000638] text-white hover:bg-[#fe0000] disabled:opacity-50 transition",children:"Atualizar"})]}),O&&bt>0&&e.jsx("div",{className:"w-64 self-center bg-gray-200 rounded-full h-2 mb-4",children:e.jsx("div",{className:"bg-[#000638] h-2 rounded-full transition-all duration-300",style:{width:`${bt}%`}})}),Mt&&e.jsx("div",{className:"text-center text-sm text-blue-600 mb-2",children:"🔍 Buscando dados de impostos..."}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-2",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(de,{empresasSelecionadas:v,onSelectEmpresas:B,apenasEmpresa101:!1})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Data Início"}),e.jsx("input",{type:"date",value:_,onChange:t=>Z(t.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] placeholder:text-gray-400 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Data Fim"}),e.jsx("input",{type:"date",value:b,onChange:t=>tt(t.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] placeholder:text-gray-400 text-xs"})]}),e.jsx("div",{className:"flex items-center",children:e.jsx("button",{type:"submit",disabled:O||!_||!b||!v.length,className:"flex items-center gap-1 bg-[#000638] text-white px-3 py-1 rounded-lg hover:bg-[#fe0000] disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors h-7 text-xs font-bold shadow-md tracking-wide uppercase",children:O?"Buscando...":"Buscar"})})]})]})}),!!(st||rt||ct||lt||dt||pt)&&e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6",children:[e.jsxs("div",{className:"shadow rounded-lg bg-white px-3 pb-3 border border-[#000638]/10",children:[e.jsx("div",{className:"text-[10px] text-gray-500",children:"Faturamento Bruto"}),e.jsx("div",{className:"text-base font-extrabold text-purple-700",children:st.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"shadow rounded-lg bg-white px-3 pb-3 border border-[#000638]/10",children:[e.jsx("div",{className:"text-[10px] text-gray-500",children:"Faturamento Líquido"}),e.jsx("div",{className:"text-base font-extrabold text-green-700",children:rt.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"shadow rounded-lg bg-white px-3 pb-3 border border-[#000638]/10",children:[e.jsx("div",{className:"text-[10px] text-gray-500",children:"ICMS Total"}),e.jsx("div",{className:"text-base font-extrabold text-teal-700",children:ct.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"shadow rounded-lg bg-white px-3 pb-3 border border-[#000638]/10",children:[e.jsx("div",{className:"text-[10px] text-gray-500",children:"Desconto Total"}),e.jsx("div",{className:"text-base font-extrabold text-orange-700",children:lt.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"shadow rounded-lg bg-white px-3 pb-3 border border-[#000638]/10",children:[e.jsx("div",{className:"text-[10px] text-gray-500",children:"PIS"}),e.jsx("div",{className:"text-base font-extrabold text-blue-700",children:dt.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"shadow rounded-lg bg-white px-3 pb-3 border border-[#000638]/10",children:[e.jsx("div",{className:"text-[10px] text-gray-500",children:"COFINS"}),e.jsx("div",{className:"text-base font-extrabold text-pink-700",children:pt.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]}),et&&e.jsx("div",{className:"mt-4 text-sm text-red-600",children:et}),xt.length>0&&e.jsx("div",{className:"mt-4 overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"receita-table min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"Canal"}),e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"Faturamento Bruto"}),e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"Desconto"}),e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"Vendas após Desconto"}),e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"ICMS"}),e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"PIS"}),e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"COFINS"}),e.jsx("th",{className:"px-1 py-0.5 text-center text-[8px] cursor-pointer hover:bg-[#000638]/80 transition-colors",children:"Receita Líquida"})]})}),e.jsx("tbody",{children:xt.map((t,o)=>e.jsxs("tr",{className:"text-gray-700 hover:bg-gray-50",children:[e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px] font-medium",children:t.canal}),e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px]",children:(t.bruto??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px]",children:(t.desconto??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px]",children:(t.vendasAposDesconto??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px]",children:(t.icms??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px]",children:(t.pis??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px]",children:(t.cofins??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"px-0.5 py-0.5 text-center text-[8px] font-semibold text-[#000638]",children:(t.receitaLiquida??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},o))})]})})]})};export{he as default};
