import{r as l,j as e,P as Se,c as Ne}from"./index-a2563983.js";import{F as De}from"./FiltroEmpresa-724027b5.js";import{F as ve,a as ye}from"./FiltroFormaPagamento-a8a8b3be.js";import{F as Fe}from"./FiltroNomeFantasia-c5463908.js";import{C as O,a as _,b as M,c as T,d as E}from"./cards-fd94db0b.js";import{n as v}from"./Clock.es-5bd0a93a.js";import{s as Pe}from"./Funnel.es-cd3339ac.js";import{p as y}from"./Spinner.es-3c850cda.js";const Re=()=>{const[B,z]=l.useState([]),[R,L]=l.useState(""),[k,U]=l.useState(""),[p,V]=l.useState(!1),[X,H]=l.useState(!1),[I,W]=l.useState("Todos"),[q,ee]=l.useState("NORMAIS"),[$,se]=l.useState([]),[F,te]=l.useState(""),[P,ae]=l.useState(""),[S,oe]=l.useState("TODOS"),[D,re]=l.useState("TODOS"),[C,ne]=l.useState([]),[A,ie]=l.useState([]),[w,le]=l.useState([]),[ce,de]=l.useState([]),[me,ue]=l.useState([]),[xe,fe]=l.useState([]),[j,ge]=l.useState({}),J="https://apigestaocrosby-bw2v.onrender.com/api/financial/",h=s=>{if(!s)return null;try{const[o]=String(s).split("T"),[t,n,c]=o.split("-").map(x=>parseInt(x,10));return!t||!n||!c?null:new Date(t,n-1,c)}catch{return null}};l.useEffect(()=>{const s=new Date,o=new Date(s.getFullYear(),s.getMonth(),1),t=new Date(s.getFullYear(),s.getMonth()+1,0);L(o.toISOString().split("T")[0]),U(t.toISOString().split("T")[0])},[]);const pe=async s=>{if(!s||s.length===0)return{};try{const o=[...new Set(s.filter(Boolean))],t=50,n=[];for(let i=0;i<o.length;i+=t)n.push(o.slice(i,i+t));const c=await Promise.all(n.map(async i=>{var a;const f=i.map(d=>`cd_pessoa=${encodeURIComponent(d)}`).join("&"),u=`${J}infopessoa?${f}`;try{const d=await fetch(u);if(!d.ok)return[];const m=await d.json();return(a=m==null?void 0:m.data)!=null&&a.data&&Array.isArray(m.data.data)?m.data.data:Array.isArray(m==null?void 0:m.data)?m.data:Array.isArray(m)?m:[]}catch{return[]}})),x={};return c.flat().forEach(i=>{if(i&&i.cd_pessoa!=null){const f=String(i.cd_pessoa).trim();x[f]=i}}),x}catch{return{}}},he=async(s=R,o=k)=>{if(!(!s||!o)){if($.length===0){alert("Selecione pelo menos uma empresa para consultar!");return}V(!0);try{const n=(await Promise.all($.map(async a=>{var d;try{const m=await fetch(`${J}contas-receberemiss?dt_inicio=${s}&dt_fim=${o}&cd_empresa=${a.cd_empresa}`);if(!m.ok)return[];const r=await m.json();let b=[];return Array.isArray(r)?b=r:r!=null&&r.dados&&Array.isArray(r.dados)?b=r.dados:r!=null&&r.data&&Array.isArray(r.data)?b=r.data:(d=r==null?void 0:r.data)!=null&&d.data&&Array.isArray(r.data.data)?b=r.data.data:r!=null&&r.result&&Array.isArray(r.result)?b=r.result:r!=null&&r.contas&&Array.isArray(r.contas)?b=r.contas:b=Object.values(r||{}),b.filter(K=>K&&typeof K=="object")}catch{return[]}}))).flat(),c=[...new Set(n.map(a=>a.cd_cliente).filter(Boolean))],x=await pe(c);ge(x);const i=Object.entries(x).filter(([a,d])=>d.nm_fantasia).map(([a,d])=>({cd_cliente:a,nm_fantasia:d.nm_fantasia})).filter((a,d,m)=>d===m.findIndex(r=>r.nm_fantasia===a.nm_fantasia));fe(i),z(n),H(!0);const f=[...new Set(n.map(a=>{var d;return JSON.stringify({cd_cliente:(d=a.cd_cliente)==null?void 0:d.toString(),nm_cliente:a.nm_cliente})}))].map(a=>JSON.parse(a)).filter(a=>a.cd_cliente&&a.nm_cliente);de(f);const u=[...new Set(n.map(a=>{var d;return JSON.stringify({codigo:(d=a.tp_documento)==null?void 0:d.toString(),descricao:Y(a.tp_documento)})}))].map(a=>JSON.parse(a)).filter(a=>a.codigo&&a.descricao);ue(u)}catch{z([]),H(!1)}finally{V(!1)}}},Y=s=>({1:"Fatura",2:"Cheque",3:"Dinheiro",4:"Cartão crédito",5:"Cartão débito",6:"Nota débito",7:"TEF",8:"Cheque TEF",9:"Troco",10:"Adiantamento (saída cx.)",11:"Desconto financeiro",12:"DOFNI",13:"Vale",14:"Nota promissória",15:"Cheque garantido",16:"TED/DOC",17:"Pré-Autorização TEF",18:"Cheque presente",19:"TEF/TECBAN - BANRISUL",20:"CREDEV",21:"Cartão próprio",22:"TEF/HYPERCARD",23:"Bônus desconto",25:"Voucher",26:"PIX",27:"PicPay",28:"Ame",29:"Mercado Pago",30:"Marketplace",31:"Outro documento"})[s]||s||"Não informado",Q=l.useCallback(s=>{if(!s||s.length===0)return[];switch(q){case"NORMAIS":return s.filter(o=>!o.dt_cancelamento);case"CANCELADAS":return s.filter(o=>o.dt_cancelamento);case"TODAS":default:return s}},[q]),Z=l.useCallback(s=>{if(!s||s.length===0)return[];switch(I){case"Pago":return s.filter(o=>parseFloat(o.vl_pago)>0);case"Vencido":return s.filter(o=>{const t=h(o.dt_vencimento),n=new Date;return n.setHours(0,0,0,0),t&&t<n});case"A Vencer":return s.filter(o=>{const t=h(o.dt_vencimento),n=new Date;return n.setHours(0,0,0,0),!t||t>=n});case"Todos":default:return s}},[I]),g=l.useMemo(()=>{let s=Q(B);return s=Z(s),s=s.filter(o=>{var t,n,c,x;if(C.length>0){const i=(t=o.cd_cliente)==null?void 0:t.toString();if(!C.some(u=>{var a;return((a=u.cd_cliente)==null?void 0:a.toString())===i}))return!1}if(F&&!(o.nr_fatura||"").toString().toLowerCase().includes(F.toLowerCase())||P&&!(o.nr_portador||"").toString().toLowerCase().includes(P.toLowerCase()))return!1;if(A.length>0){const i=(n=o.tp_documento)==null?void 0:n.toString();if(!A.some(u=>{var a;return((a=u.codigo)==null?void 0:a.toString())===i}))return!1}if(w.length>0&&j&&Object.keys(j).length>0){const i=String(o.cd_cliente||"").trim(),f=(c=j[i])==null?void 0:c.nm_fantasia;if(!w.some(a=>a.nm_fantasia===f))return!1}if(S!=="TODOS"){const i=o.tp_cobranca;if(S==="DESCONTADA"&&i!=="2"||S==="NÃO ESTÁ EM COBRANÇA"&&i!=="0"||S==="SIMPLES"&&i!=="1")return!1}if(D!=="TODOS"&&j&&Object.keys(j).length>0){const i=String(o.cd_cliente||"").trim(),u=(((x=j[i])==null?void 0:x.nm_fantasia)||"").toUpperCase().includes(" - CROSBY");if(D==="FRANQUIAS"&&!u||D==="OUTROS"&&u)return!1}return!0}),s},[B,Q,Z,C,F,P,A,w,S,D,j]),be=l.useMemo(()=>{if(!g||g.length===0)return 0;let s=0,o=0;const t=new Date;return t.setHours(0,0,0,0),g.forEach(n=>{const c=h(n.dt_emissao),x=n.dt_liq?h(n.dt_liq):t;if(!c)return;const i=Math.max(0,Math.floor((x-c)/(1e3*60*60*24))),f=parseFloat(n.vl_fatura)||0;f>0&&(s+=i*f,o+=f)}),o===0?0:s/o},[g]),G=l.useMemo(()=>{if(!g||g.length===0)return[];const s={},o=new Date;return o.setHours(0,0,0,0),g.forEach(t=>{var a;const n=(a=t.tp_documento)==null?void 0:a.toString(),c=Y(n);s[c]||(s[c]={nome:c,somaPonderadaDias:0,somaPesos:0,quantidade:0});const x=h(t.dt_emissao),i=t.dt_liq?h(t.dt_liq):o;if(!x)return;const f=Math.max(0,Math.floor((i-x)/(1e3*60*60*24))),u=parseFloat(t.vl_fatura)||0;u>0&&(s[c].somaPonderadaDias+=f*u,s[c].somaPesos+=u,s[c].quantidade+=1)}),Object.values(s).filter(t=>t.somaPesos>0).map(t=>({...t,pmrDias:t.somaPesos>0?t.somaPonderadaDias/t.somaPesos:0})).sort((t,n)=>n.somaPesos-t.somaPesos)},[g]),N=l.useMemo(()=>{if(!g||g.length===0)return{mais15Dias:0,menos15Dias:0,valorMais15Dias:0,valorMenos15Dias:0,pmrMais15Dias:0,pmrMenos15Dias:0};let s=0,o=0,t=0,n=0,c=0,x=0;g.forEach(u=>{if(!u.dt_liq)return;const a=h(u.dt_emissao),d=h(u.dt_liq);if(!a||!d)return;const m=Math.floor((d-a)/(1e3*60*60*24)),r=parseFloat(u.vl_fatura)||0;r>0&&(m>15?(s+=1,t+=r,c+=m*r):m<=15&&(o+=1,n+=r,x+=m*r))});const i=t>0?c/t:0,f=n>0?x/n:0;return{mais15Dias:s,menos15Dias:o,valorMais15Dias:t,valorMenos15Dias:n,pmrMais15Dias:i,pmrMenos15Dias:f}},[g]),je=s=>{s.preventDefault(),he()};return e.jsxs("div",{className:"w-full max-w-6xl mx-auto flex flex-col items-stretch justify-start py-8 px-4",children:[e.jsx(Se,{title:"PMR - Prazo Médio de Recebimento",subtitle:"Análise do prazo médio de recebimento baseado nos dados de contas a receber",icon:v,iconColor:"text-green-600"}),e.jsx("div",{className:"mb-4",children:e.jsxs("form",{onSubmit:je,className:"flex flex-col bg-white p-3 rounded-lg shadow-md w-full max-w-4xl mx-auto border border-[#000638]/10",children:[e.jsxs("div",{className:"mb-2",children:[e.jsxs("span",{className:"text-lg font-bold text-[#000638] flex items-center gap-1",children:[e.jsx(Pe,{size:18,weight:"bold"}),"Filtros"]}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"Selecione o período e empresa para análise"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 mb-3",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(De,{empresasSelecionadas:$,onSelectEmpresas:se,apenasEmpresa101:!0})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Data Início"}),e.jsx("input",{type:"date",value:R,onChange:s=>L(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] placeholder:text-gray-400 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Data Fim"}),e.jsx("input",{type:"date",value:k,onChange:s=>U(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] placeholder:text-gray-400 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Status"}),e.jsxs("select",{value:I,onChange:s=>W(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] text-xs",children:[e.jsx("option",{value:"Todos",children:"TODOS"}),e.jsx("option",{value:"Pago",children:"PAGO"}),e.jsx("option",{value:"Vencido",children:"VENCIDO"}),e.jsx("option",{value:"A Vencer",children:"A VENCER"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-2 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Situação"}),e.jsxs("select",{value:q,onChange:s=>ee(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] text-xs",children:[e.jsx("option",{value:"NORMAIS",children:"NORMAIS"}),e.jsx("option",{value:"CANCELADAS",children:"CANCELADAS"}),e.jsx("option",{value:"TODAS",children:"TODAS"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Cobrança"}),e.jsxs("select",{value:S,onChange:s=>oe(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] text-xs",children:[e.jsx("option",{value:"TODOS",children:"TODOS"}),e.jsx("option",{value:"DESCONTADA",children:"DESCONTADA"}),e.jsx("option",{value:"NÃO ESTÁ EM COBRANÇA",children:"NÃO ESTÁ EM COBRANÇA"}),e.jsx("option",{value:"SIMPLES",children:"SIMPLES"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Tipo Cliente"}),e.jsxs("select",{value:D,onChange:s=>re(s.target.value),className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] text-xs",children:[e.jsx("option",{value:"TODOS",children:"TODOS"}),e.jsx("option",{value:"FRANQUIAS",children:"FRANQUIAS"}),e.jsx("option",{value:"OUTROS",children:"OUTROS"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Fatura"}),e.jsx("input",{type:"text",value:F,onChange:s=>te(s.target.value),placeholder:"Buscar fatura...",className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] placeholder:text-gray-400 text-xs"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-0.5 text-[#000638]",children:"Portador"}),e.jsx("input",{type:"text",value:P,onChange:s=>ae(s.target.value),placeholder:"Buscar portador...",className:"border border-[#000638]/30 rounded-lg px-2 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-[#000638] bg-[#f8f9fb] text-[#000638] placeholder:text-gray-400 text-xs"})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(ve,{clientesSelecionados:C,onSelectClientes:ne,dadosClientes:ce})}),e.jsx("div",{className:"lg:col-3",children:e.jsx(ye,{formasPagamentoSelecionadas:A,onSelectFormasPagamento:ie,dadosFormasPagamento:me})}),e.jsx("div",{className:"lg:col-span-3",children:e.jsx(Fe,{nomesFantasiaSelecionados:w,onSelectNomesFantasia:le,dadosNomesFantasia:xe})}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{type:"submit",className:"flex items-center gap-1 bg-[#000638] text-white px-3 py-1 rounded-lg hover:bg-[#fe0000] disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors h-7 text-xs font-bold shadow-md tracking-wide uppercase",disabled:p||!R||!k,children:p?e.jsxs(e.Fragment,{children:[e.jsx(y,{size:10,className:"animate-spin"}),e.jsx("span",{})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{size:10}),e.jsx("span",{children:"Buscar"})]})})})]})]})}),X&&e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-w-7xl mx-auto",children:[e.jsxs(O,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(_,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{size:18,className:"text-green-700"}),e.jsx(M,{className:"text-sm font-bold text-green-700",children:"Prazo Médio de Recebimento"})]})}),e.jsxs(T,{className:"pt-0 px-4 pb-4",children:[e.jsx("div",{className:"text-3xl font-extrabold text-green-700 mb-1 break-words",children:p?e.jsx(y,{size:24,className:"animate-spin text-green-700"}):`${be.toFixed(1)} dias`}),e.jsx(E,{className:"text-xs text-gray-500",children:"Média ponderada por valor entre emissão e recebimento"})]})]}),e.jsxs(O,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(_,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{size:18,className:"text-red-600"}),e.jsx(M,{className:"text-sm font-bold text-red-700",children:"Faturas Pagas a + de 15 Dias"})]})}),e.jsxs(T,{className:"pt-0 px-4 pb-4",children:[e.jsx("div",{className:"text-2xl font-extrabold text-red-600 mb-1 break-words",children:p?e.jsx(y,{size:24,className:"animate-spin text-red-600"}):`${N.pmrMais15Dias.toFixed(1)} dias`}),e.jsx("div",{className:"text-sm font-medium text-red-500 mb-1",children:p?"...":`${N.mais15Dias} faturas • R$ ${N.valorMais15Dias.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`}),e.jsx(E,{className:"text-xs text-gray-500",children:"PMR das faturas pagas após 15 dias da emissão"})]})]}),e.jsxs(O,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(_,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{size:18,className:"text-green-600"}),e.jsx(M,{className:"text-sm font-bold text-green-700",children:"Faturas Pagas a - de 15 Dias"})]})}),e.jsxs(T,{className:"pt-0 px-4 pb-4",children:[e.jsx("div",{className:"text-2xl font-extrabold text-green-600 mb-1 break-words",children:p?e.jsx(y,{size:24,className:"animate-spin text-green-600"}):`${N.pmrMenos15Dias.toFixed(1)} dias`}),e.jsx("div",{className:"text-sm font-medium text-green-500 mb-1",children:p?"...":`${N.menos15Dias} faturas • R$ ${N.valorMenos15Dias.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`}),e.jsx(E,{className:"text-xs text-gray-500",children:"PMR das faturas pagas em até 15 dias da emissão"})]})]})]}),G.length>0&&e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("h3",{className:"text-lg font-bold text-[#000638] mb-4 text-center",children:"PMR por Forma de Pagamento"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:G.map((s,o)=>e.jsxs(O,{className:"shadow-lg transition-all duration-200 hover:shadow-xl hover:-translate-y-1 rounded-xl bg-white",children:[e.jsx(_,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{size:14,className:"text-blue-600"}),e.jsx(M,{className:"text-xs font-bold text-blue-700 truncate",title:s.nome,children:s.nome})]})}),e.jsxs(T,{className:"pt-0 px-2 pb-2",children:[e.jsx("div",{className:"text-sm font-extrabold text-blue-600 mb-0.5 break-words",children:p?e.jsx(y,{size:18,className:"animate-spin text-blue-600"}):`${s.pmrDias.toFixed(1)} dias`}),e.jsxs(E,{className:"text-xs text-gray-500",children:[s.quantidade," transação",s.quantidade!==1?"ões":""," • R$ ",s.somaPesos.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]},o))})]})]})]})};export{Re as default};
