import{r as n,j as t,P as A,p as $}from"./index-a2563983.js";import{u as I}from"./useApiClient-0bf86fc1.js";import{F as O}from"./FiltroEmpresa-724027b5.js";const H=()=>{const E=I(),[k,C]=n.useState(!1),[D,N]=n.useState(""),[S,F]=n.useState([]),[l,h]=n.useState(1),b=20,[o,y]=n.useState({dt_inicio:"",dt_fim:"",nr_transacao:"",cd_pessoa:"",cd_empresa:""}),[q,L]=n.useState([]),P=e=>{L(e)};n.useEffect(()=>{const e=new Date,s=new Date(e.getFullYear(),e.getMonth(),1).toISOString().split("T")[0],i=new Date(e.getFullYear(),e.getMonth()+1,0).toISOString().split("T")[0];y(a=>({...a,dt_inicio:s,dt_fim:i}))},[]);const V=async()=>{var e;try{C(!0),N("");const s={dt_inicio:o.dt_inicio,dt_fim:o.dt_fim},i=(q||[]).filter(r=>r&&r.cd_empresa!==void 0&&r.cd_empresa!==null&&r.cd_empresa!=="").map(r=>r.cd_empresa);i.length>0&&(s.cd_empresa=i),o.nr_transacao&&String(o.nr_transacao).trim()!==""&&(s.nr_transacao=String(o.nr_transacao).trim()),o.cd_pessoa&&String(o.cd_pessoa).trim()!==""&&(s.cd_pessoa=String(o.cd_pessoa).trim());const a=await E.sales.cmvvarejo(s);if(!a.success){N(a.message||"Falha ao carregar dados"),F([]);return}const d=Array.isArray((e=a==null?void 0:a.data)==null?void 0:e.data)?a.data.data:Array.isArray(a==null?void 0:a.data)?a.data:[];F(d),h(1)}catch(s){N("Erro ao buscar dados"),console.error(s)}finally{C(!1)}},x=e=>{if(e==null)return 0;if(typeof e=="number")return e;const s=Number(String(e).trim());return Number.isNaN(s)?0:s},u=e=>x(e).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),B=e=>{if(!e)return"";const s=typeof e=="string"?e:new Date(e).toISOString(),i=s.includes("T")?s.split("T")[0]:s,[a,d,r]=i.split("-");return!a||!d||!r?String(e):`${r}/${d}/${a}`},R=e=>x(e).toLocaleString("pt-BR",{minimumFractionDigits:0,maximumFractionDigits:3}),M=n.useMemo(()=>[{key:"nm_grupoempresa",header:"Empresa"},{key:"dt_transacao",header:"Referência",format:B},{key:"nr_transacao",header:"Nr Transação"},{key:"cd_pessoa",header:"Cd Pessoa"},{key:"nm_pessoa",header:"Nm Pessoa"},{key:"ds_nivel",header:"Descrição"},{key:"qt_faturado",header:"Qt Faturado",format:R},{key:"vl_unitliquido",header:"Líquido",format:u},{key:"vl_unitbruto",header:"Bruto",format:u},{key:"vl_produto",header:"CMV",format:u},{key:"vl_freterat",header:"Frete Rateado",format:u}],[]),c=n.useMemo(()=>{const e=String(o.nr_transacao||"").trim(),s=String(o.cd_pessoa||"").trim(),i=String(o.cd_empresa||"").trim();return!e&&!s&&!i?S:S.filter(a=>{let d=!0;return e&&(d=d&&String((a==null?void 0:a.nr_transacao)||"").includes(e)),s&&(d=d&&String((a==null?void 0:a.cd_pessoa)||"").includes(s)),i&&(d=d&&String((a==null?void 0:a.cd_grupoempresa)||(a==null?void 0:a.cd_empresa)||"").includes(i)),d})},[S,o.nr_transacao,o.cd_pessoa,o.cd_empresa]),g=n.useMemo(()=>{const e=Math.ceil((c.length||0)/b);return Math.max(1,e||1)},[c.length]),T=n.useMemo(()=>{const e=(l-1)*b,s=e+b;return c.slice(e,s)},[c,l]);n.useEffect(()=>{l>g?h(g):l<1&&h(1)},[l,g]);const m=n.useMemo(()=>{let e=0,s=0,i=0,a=0,d=0;for(const r of c){const f=x(r==null?void 0:r.qt_faturado)||1,v=x(r==null?void 0:r.vl_freterat)||0,j=x(r==null?void 0:r.vl_unitliquido)*f+v,_=x(r==null?void 0:r.vl_unitbruto)*f+v,p=x(r==null?void 0:r.vl_produto)*f;String(r==null?void 0:r.tp_operacao).trim()==="E"?(e-=Math.abs(j),s-=Math.abs(_),i+=Math.abs(j),a-=Math.abs(p)):(e+=j,s+=_,a+=p),d+=v}return{totalLiquido:e,totalBruto:s,totalDevolucoes:i,totalCMV:a,totalFrete:d}},[c]);return t.jsxs("div",{className:"w-full max-w-7xl mx-auto p-4",children:[t.jsx(A,{title:"CMV Varejo",subtitle:"Consulta da rota /cmvvarejo",icon:$,iconColor:"text-indigo-600"}),t.jsxs("div",{className:"bg-white rounded-lg shadow p-3 mb-4 border border-gray-200",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[t.jsx("div",{className:"sm:col-span-3",children:t.jsx(O,{empresasSelecionadas:q,onSelectEmpresas:P})}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Data Início"}),t.jsx("input",{type:"date",value:o.dt_inicio,onChange:e=>y(s=>({...s,dt_inicio:e.target.value})),className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Data Fim"}),t.jsx("input",{type:"date",value:o.dt_fim,onChange:e=>y(s=>({...s,dt_fim:e.target.value})),className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Nr Transação"}),t.jsx("input",{type:"text",value:o.nr_transacao,onChange:e=>y(s=>({...s,nr_transacao:e.target.value})),placeholder:"Ex.: 685924",className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Cd Pessoa"}),t.jsx("input",{type:"text",value:o.cd_pessoa,onChange:e=>y(s=>({...s,cd_pessoa:e.target.value})),placeholder:"Ex.: 19295",className:"border rounded px-2 py-1.5 w-full text-xs"})]}),t.jsx("div",{className:"flex items-end",children:t.jsx("button",{onClick:V,disabled:k||!o.dt_inicio||!o.dt_fim,className:"bg-indigo-600 text-white text-xs px-3 py-2 rounded hover:bg-indigo-700 disabled:opacity-50",children:k?"Buscando...":"Buscar"})})]}),D&&t.jsx("div",{className:"mt-2 text-xs text-red-600",children:D})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-9 gap-3 mb-4",children:[t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Receita Liq + Imp"}),t.jsx("div",{className:"text-lg font-semibold text-green-600",children:u(m.totalLiquido)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Receita Bruta"}),t.jsx("div",{className:"text-lg font-semibold text-blue-600",children:u(m.totalBruto)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Total de Devoluções"}),t.jsx("div",{className:"text-lg font-semibold text-red-600",children:u(m.totalDevolucoes)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Total CMV"}),t.jsx("div",{className:"text-lg font-semibold",children:u(m.totalCMV)})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"CMV %"}),t.jsx("div",{className:"text-lg font-semibold",children:(()=>{const e=Math.abs(m.totalLiquido)||0;return e?`${(m.totalCMV/e*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}%`:"0,00%"})()})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Margem %"}),t.jsx("div",{className:"text-lg font-semibold",children:(()=>{const e=Math.abs(m.totalLiquido)||0;return e?`${((m.totalLiquido-m.totalCMV)/e*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}%`:"0,00%"})()})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Markup"}),t.jsx("div",{className:"text-lg font-semibold",children:(()=>{const e=Math.abs(m.totalCMV)||0;return e?`${(m.totalLiquido/e).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}x`:"—"})()})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsx("div",{className:"text-xs text-gray-500",children:"Total Frete"}),t.jsx("div",{className:"text-lg font-semibold",children:u(m.totalFrete)})]})]}),t.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-3",children:[t.jsxs("div",{className:"text-xs text-gray-600 mb-2",children:["Registros: ",c.length,c.length>0&&t.jsxs("span",{className:"ml-2 text-blue-600 font-medium",children:["Mostrando ",(l-1)*b+1,"-",Math.min(l*b,c.length)," ","de ",c.length]})]}),t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full text-xs border-collapse",children:[t.jsx("thead",{className:"bg-gray-100",children:t.jsx("tr",{children:M.map(e=>t.jsx("th",{className:"px-2 py-1 text-left font-semibold text-gray-700",children:e.header},e.key))})}),t.jsxs("tbody",{children:[T.map((e,s)=>t.jsx("tr",{className:s%2===0?"bg-white":"bg-gray-50",children:M.map(i=>{let a=i.key==="__perc"?void 0:e[i.key];const d=i.key==="vl_unitliquido"||i.key==="vl_unitbruto"||i.key==="vl_produto",r=String(e==null?void 0:e.tp_operacao).trim()==="E",f=x(e==null?void 0:e.qt_faturado)||1,v=x(e==null?void 0:e.vl_freterat)||0;if(d){let p;i.key==="vl_produto"?p=x(a)*f:p=x(a)*f+v,a=r?-Math.abs(p):p}const j=i.format?i.format(a,e):a??"",_=d&&r?" text-red-600":"";return t.jsx("td",{className:`px-2 py-1${_}`,children:j},i.key)})},s)),c.length===0&&t.jsx("tr",{children:t.jsx("td",{className:"px-2 py-4 text-center text-gray-500",colSpan:M.length,children:"Nenhum registro"})})]})]})}),c.length>b&&t.jsxs("div",{className:"mt-3 flex items-center justify-between text-xs",children:[t.jsxs("div",{children:[" ","Página ",l," de ",g," "]}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(1),disabled:l===1,children:"« Primeira"}),t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(e=>Math.max(1,e-1)),disabled:l===1,children:"‹ Anterior"}),t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(e=>Math.min(g,e+1)),disabled:l===g,children:"Próxima ›"}),t.jsx("button",{className:"px-2 py-1 border rounded disabled:opacity-50",onClick:()=>h(g),disabled:l===g,children:"Última »"})]})]})]})]})};export{H as default};
