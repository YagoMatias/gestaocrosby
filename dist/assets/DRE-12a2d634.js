import{r as t,j as a,P as zs,g as Ga,L as Us,s as ua,e as pa}from"./index-a2563983.js";import{u as ks}from"./useApiClient-0bf86fc1.js";import{s as Js}from"./Funnel.es-cd3339ac.js";import{g as Gs}from"./categoriasDespesas-4bfb6d86.js";const et=()=>{const N=ks(),[ze,ma]=t.useState(!1),[_,L]=t.useState(""),[va,fa]=t.useState(""),[Le,Ya]=t.useState(0),[Ae,Za]=t.useState(0),[Ue,Qa]=t.useState(0),[ga,Ka]=t.useState(0),[ke,Xa]=t.useState(0),[Je,Ha]=t.useState(0),[me,Wa]=t.useState(0),[A,es]=t.useState({totalBruto:0,totalDevolucoes:0,totalCMV:0,totalLiquido:0}),[E,as]=t.useState({totalBruto:0,totalDevolucoes:0,totalCMV:0,totalLiquido:0}),[R,ss]=t.useState({totalBruto:0,totalDevolucoes:0,totalCMV:0,totalLiquido:0}),[B,ts]=t.useState({totalBruto:0,totalDevolucoes:0,totalCMV:0,totalLiquido:0}),[ha,xa]=t.useState([]),[xe,ba]=t.useState(0),[Sa,os]=t.useState([]),[Ee,rs]=t.useState(0),[cs,Ys]=t.useState(new Set([117,124,270,271,272,5006,5007,5013,5014,11006,11008,11004,11003,11009,11009,11007,11005,11001,14e3,13e3])),ya=s=>{const r=Number(s);return Number.isNaN(r)?!1:cs.has(r)},[Ca,is]=t.useState(0),[ja,ds]=t.useState(0),[_a,ls]=t.useState(0),[Re,ns]=t.useState(0),[ie,us]=t.useState({icms:0,pis:0,cofins:0}),[de,ps]=t.useState({icms:0,pis:0,cofins:0}),[le,ms]=t.useState({icms:0,pis:0,cofins:0}),[ne,vs]=t.useState({icms:0,pis:0,cofins:0}),[qa,fs]=t.useState(0),[Da,gs]=t.useState(0),[Ma,hs]=t.useState(0),[Na,xs]=t.useState(0),[La,bs]=t.useState(0),[Aa,Ss]=t.useState(0),[Ea,ys]=t.useState(0),[Ra,Cs]=t.useState(0),[Ba,js]=t.useState(0),[Fa,_s]=t.useState(0),[Ia,qs]=t.useState(0),[Va,Ds]=t.useState(0),[l,Be]=t.useState({dt_inicio:"",dt_fim:"",empresas:[1,2,3,4,5]}),[Ms,Ns]=t.useState("ANO"),Ls=(s,r)=>new Date(r,s,0).getDate(),As=s=>{if(Ns(s),s==="ANO")return;const p={JAN:1,FEV:2,MAR:3,ABR:4,MAI:5,JUN:6,JUL:7,AGO:8,SET:9,OUT:10,NOV:11,DEZ:12}[s];if(!p)return;const v=(()=>{if(l.dt_inicio){const[P]=l.dt_inicio.split("-"),z=parseInt(P,10);if(z>1900)return z}return new Date().getFullYear()})(),y=`${v}-${String(p).padStart(2,"0")}-01`,g=Ls(p,v),F=`${v}-${String(p).padStart(2,"0")}-${String(g).padStart(2,"0")}`;Be(P=>({...P,dt_inicio:y,dt_fim:F}))};t.useState({"vendas-bruta":!0,"deducoes-vendas":!0,"impostos-vendas":!0,"receita-liquida":!0,"lucro-bruto":!0,"despesas-operacionais":!0,"resultado-operacional":!0,"outras-receitas-despesas":!0,"despesas-financeiras":!0,"lucro-antes-impostos":!0,"impostos-lucro":!0,"lucro-liquido":!0});const[Fe,Ge]=t.useState(new Set),[Ie,Es]=t.useState(!1);t.useEffect(()=>{const s=new Date,r=new Date(s.getFullYear(),s.getMonth(),1).toISOString().split("T")[0],p=new Date(s.getFullYear(),s.getMonth()+1,0).toISOString().split("T")[0];Be(v=>({...v,dt_inicio:r,dt_fim:p}))},[]);const Rs=t.useCallback(async()=>{var s,r,p,v,y,g,F,P,z,ve,C,be,Se,ye,fe;if(!(!l.dt_inicio||!l.dt_fim)){ma(!0),fa("");try{const q={dataInicio:l.dt_inicio,dataFim:l.dt_fim},U=[91,2,5,6,7,11,31,55,65,75,85,90,91,92,93,94,95,96,97,98,99],wa=[2,5,55,65,90,91,92,93,94,95,96,97,98,200,500,550,650,890,910,920,930,940,950,960,970,980],Fs={dataInicio:l.dt_inicio,dataFim:l.dt_fim,cd_grupoempresa:wa},Is={dataInicio:l.dt_inicio,dataFim:l.dt_fim,cd_grupoempresa:U},Vs={dataInicio:l.dt_inicio,dataFim:l.dt_fim,cd_grupoempresa:U},$s={dataInicio:l.dt_inicio,dataFim:l.dt_fim,cd_grupoempresa:U};L("Buscando dados de faturamento do Varejo...");const k=await N.sales.faturamentoVarejo(q);L("Buscando dados de faturamento do Multimarcas...");const J=await N.sales.faturamentoMtm(q);L("Buscando dados de faturamento das Franquias...");const G=await N.sales.faturamentoFranquias(q);L("Buscando dados de faturamento da Revenda...");const Y=await N.sales.faturamentoRevenda(q);L("Buscando CMV do Varejo...");const Z=await N.sales.cmvVarejo(Fs);L("Buscando CMV do Multimarcas...");const Q=await N.sales.cmvMultimarcas(Is);L("Buscando CMV das Franquias...");const K=await N.sales.cmvFranquias(Vs);L("Buscando CMV da Revenda...");const X=await N.sales.cmvRevenda($s);L("Processando dados...");const $e=c=>{if(!(c!=null&&c.success)||!(c!=null&&c.data))return{receitaBruta:0,devolucoesBrutas:0,receitaLiquida:0,devolucoesLiquidas:0,descontos:0};const Me=Array.isArray(c.data)?c.data:[];let n=0,x=0,ce=0,b=0;for(const h of Me)n+=parseFloat((h==null?void 0:h.valor_sem_desconto)||0),x+=parseFloat((h==null?void 0:h.valor_sem_desconto_entrada)||0),ce+=parseFloat((h==null?void 0:h.valor_com_desconto)||0),b+=parseFloat((h==null?void 0:h.valor_com_desconto_entrada)||0);const he=n-ce;return{receitaBruta:n,devolucoesBrutas:x,receitaLiquida:ce,devolucoesLiquidas:b,descontos:he}},we=c=>{if(!(c!=null&&c.success)||!(c!=null&&c.data))return{cmv:0,produtosSaida:0,produtosEntrada:0};const Me=Array.isArray(c.data)?c.data:[];let n=0,x=0,ce=0;for(const b of Me)n+=parseFloat((b==null?void 0:b.cmv)||0),x+=parseFloat((b==null?void 0:b.produtos_saida)||0),ce+=parseFloat((b==null?void 0:b.produtos_entrada)||0);return{cmv:n,produtosSaida:x,produtosEntrada:ce}},H=$e(k),W=$e(J),ee=$e(G),ae=$e(Y),Ze=we(Z),Qe=we(Q),Ke=we(K),Xe=we(X),Ce=H.receitaBruta+W.receitaBruta+ee.receitaBruta+ae.receitaBruta,je=H.devolucoesLiquidas+W.devolucoesLiquidas+ee.devolucoesLiquidas+ae.devolucoesLiquidas,_e=H.descontos+W.descontos+ee.descontos+ae.descontos,Qs=H.receitaLiquida+W.receitaLiquida+ee.receitaLiquida+ae.receitaLiquida,ge=Ze.cmv+Qe.cmv+Ke.cmv+Xe.cmv;console.log("ðŸ“Š CMV calculado das views materializadas:",{varejo:Ze.cmv,multimarcas:Qe.cmv,franquias:Ke.cmv,revenda:Xe.cmv,total:ge,observacao:"Usa apenas a coluna CMV das views cmv_varejo, cmv_mtm, cmv_franquias, cmv_revenda"});const I={totalBruto:H.receitaBruta,totalDevolucoes:H.devolucoesLiquidas,totalLiquido:H.receitaLiquida,totalCMV:Ze.cmv,descontos:H.descontos},V={totalBruto:W.receitaBruta,totalDevolucoes:W.devolucoesLiquidas,totalLiquido:W.receitaLiquida,totalCMV:Qe.cmv,descontos:W.descontos},$={totalBruto:ee.receitaBruta,totalDevolucoes:ee.devolucoesLiquidas,totalLiquido:ee.receitaLiquida,totalCMV:Ke.cmv,descontos:ee.descontos},w={totalBruto:ae.receitaBruta,totalDevolucoes:ae.devolucoesLiquidas,totalLiquido:ae.receitaLiquida,totalCMV:Xe.cmv,descontos:ae.descontos};L("Buscando impostos por canal...");let o=null;try{const c=await N.sales.impostosPorCanal({dataInicio:l.dt_inicio,dataFim:l.dt_fim});c!=null&&c.success&&(c!=null&&c.data)&&(o=c.data,console.log("ðŸ’° Impostos recebidos da API:",o))}catch(c){console.error("âš ï¸ Erro ao buscar impostos, usando valores zerados:",c)}const se={icms:((s=o==null?void 0:o.varejo)==null?void 0:s.icms)||0,pis:((r=o==null?void 0:o.varejo)==null?void 0:r.pis)||0,cofins:((p=o==null?void 0:o.varejo)==null?void 0:p.cofins)||0},te={icms:((v=o==null?void 0:o.multimarcas)==null?void 0:v.icms)||0,pis:((y=o==null?void 0:o.multimarcas)==null?void 0:y.pis)||0,cofins:((g=o==null?void 0:o.multimarcas)==null?void 0:g.cofins)||0},oe={icms:((F=o==null?void 0:o.franquias)==null?void 0:F.icms)||0,pis:((P=o==null?void 0:o.franquias)==null?void 0:P.pis)||0,cofins:((z=o==null?void 0:o.franquias)==null?void 0:z.cofins)||0},re={icms:((ve=o==null?void 0:o.revenda)==null?void 0:ve.icms)||0,pis:((C=o==null?void 0:o.revenda)==null?void 0:C.pis)||0,cofins:((be=o==null?void 0:o.revenda)==null?void 0:be.cofins)||0};us(se),ps(te),ms(oe),vs(re);const He=se.icms+te.icms+oe.icms+re.icms,We=se.pis+te.pis+oe.pis+re.pis,ea=se.cofins+te.cofins+oe.cofins+re.cofins,qe=He+We+ea;console.log("ðŸ’° Impostos processados:",{varejo:se,multimarcas:te,franquias:oe,revenda:re,totais:{icms:He,pis:We,cofins:ea,total:qe}});const Oe=je+_e+qe;console.log("ðŸ“Š CÃ¡lculo das DeduÃ§Ãµes sobre Vendas (Views Materializadas):",{devolucoes:je,descontos:_e,impostos:qe,totalDeducoes:Oe,formula:"DevoluÃ§Ãµes LÃ­quidas + Descontos Concedidos + Impostos",detalhamento:{vendas_brutas:Ce,devolucoes_liquidas:je,descontos_concedidos:_e,impostos:qe}});const De=Ce-Oe,aa=De-ge,sa=I.totalBruto-(I.totalDevolucoes+I.descontos+se.icms+se.pis+se.cofins),ta=V.totalBruto-(V.totalDevolucoes+V.descontos+te.icms+te.pis+te.cofins),oa=$.totalBruto-($.totalDevolucoes+$.descontos+oe.icms+oe.pis+oe.cofins),ra=w.totalBruto-(w.totalDevolucoes+w.descontos+re.icms+re.pis+re.cofins),ca=I.totalCMV,ia=V.totalCMV,da=$.totalCMV,la=w.totalCMV,Oa=sa-ca,Pa=ta-ia,Ta=oa-da,za=ra-la;fs(sa),gs(ta),hs(oa),xs(ra),bs(ca),Ss(ia),ys(da),Cs(la),js(Oa),_s(Pa),qs(Ta),Ds(za),console.log("ðŸ“Š Receitas LÃ­quidas por canal:",{varejo:sa,multimarcas:ta,franquias:oa,revenda:ra,total:De}),console.log("ðŸ“Š CMV por canal:",{varejo:ca,multimarcas:ia,franquias:da,revenda:la,total:ge}),console.log("ðŸ“Š Lucro Bruto por canal:",{varejo:Oa,multimarcas:Pa,franquias:Ta,revenda:za,total:aa,formula:"Receita LÃ­quida - CMV"}),console.log("ðŸ“Š Empresas utilizadas:",{varejo:wa.length+" empresas",multimarcas:U.length+" empresas",franquias:U.length+" empresas",revenda:U.length+" empresas"}),console.log("ðŸ“Š Dados recebidos das rotas MATERIALIZADAS:",{faturamento:{varejo:{success:k==null?void 0:k.success,dataLength:Array.isArray(k==null?void 0:k.data)?k.data.length:0},multimarcas:{success:J==null?void 0:J.success,dataLength:Array.isArray(J==null?void 0:J.data)?J.data.length:0},franquias:{success:G==null?void 0:G.success,dataLength:Array.isArray(G==null?void 0:G.data)?G.data.length:0},revenda:{success:Y==null?void 0:Y.success,dataLength:Array.isArray(Y==null?void 0:Y.data)?Y.data.length:0}},cmv:{varejo:{success:Z==null?void 0:Z.success,dataLength:Array.isArray(Z==null?void 0:Z.data)?Z.data.length:0},multimarcas:{success:Q==null?void 0:Q.success,dataLength:Array.isArray(Q==null?void 0:Q.data)?Q.data.length:0},franquias:{success:K==null?void 0:K.success,dataLength:Array.isArray(K==null?void 0:K.data)?K.data.length:0},revenda:{success:X==null?void 0:X.success,dataLength:Array.isArray(X==null?void 0:X.data)?X.data.length:0}}}),console.log("ðŸ“Š Totais por Segmento (Views Materializadas):",{varejo:{receitaBruta:I.totalBruto,devolucoes:I.totalDevolucoes,descontos:I.descontos,cmv:I.totalCMV},multimarcas:{receitaBruta:V.totalBruto,devolucoes:V.totalDevolucoes,descontos:V.descontos,cmv:V.totalCMV},franquias:{receitaBruta:$.totalBruto,devolucoes:$.totalDevolucoes,descontos:$.descontos,cmv:$.totalCMV},revenda:{receitaBruta:w.totalBruto,devolucoes:w.totalDevolucoes,descontos:w.descontos,cmv:w.totalCMV}}),console.log("ðŸ“Š RECEITAS BRUTAS (coluna valor_sem_desconto):",{total:Ce,formula:"Soma APENAS da coluna VALOR_SEM_DESCONTO de todos os canais",observacao:"Usa a soma total (saÃ­da - entrada jÃ¡ calculada na view)"}),console.log("ðŸ“Š DEVOLUÃ‡Ã•ES (valor_com_desconto_entrada):",{total:je,formula:"Soma das entradas com desconto de todos os canais"}),console.log("ðŸ“Š DESCONTOS CONCEDIDOS:",{total:_e,formula:"valor_sem_desconto - valor_com_desconto (direto das colunas)",porCanal:{varejo:I.descontos,multimarcas:V.descontos,franquias:$.descontos,revenda:w.descontos}}),console.log("ðŸ“Š CMV Total:",{total:ge,formula:"Soma do CMV de todas as rotas CMV materializadas",porCanal:{varejo:I.totalCMV,multimarcas:V.totalCMV,franquias:$.totalCMV,revenda:w.totalCMV}}),console.log("ðŸ“Š Receita LÃ­quida:",{vendasBrutas:Ce,totalDeducoes:Oe,receitaLiquida:De,formula:"Vendas Brutas - (DevoluÃ§Ãµes + Descontos + Impostos)"}),console.log("ðŸ“Š Lucro Bruto:",{receitaLiquida:De,cmv:ge,lucroBruto:aa,formula:"Receita LÃ­quida - CMV"}),Ya(Ce),Za(je),Qa(_e),Ka(Oe),es(I),as(V),ss($),ts(w),Xa(ge),Ha(De),Wa(aa),is(He),ds(We),ls(ea),ns(qe);try{L("Buscando Contas a Pagar (EmissÃ£o)...");const c=[1,2,5,6,7,11,31,55,65,75,85,90,91,92,93,94,95,96,97,98,99,100,101,111,200,311,500,550,600,650,700,750,850,890,910,920,930,940,950,960,970,980,990],Me={dt_inicio:l.dt_inicio,dt_fim:l.dt_fim,cd_empresa:c},n=await N.financial.contasPagarEmissao(Me);L("Buscando nomes das despesas e fornecedores...");let x=[];Array.isArray(n==null?void 0:n.data)?x=n.data:(Se=n==null?void 0:n.data)!=null&&Se.data&&Array.isArray(n.data.data)?x=n.data.data:Array.isArray(n==null?void 0:n.rows)?x=n.rows:(ye=n==null?void 0:n.data)!=null&&ye.rows&&Array.isArray(n.data.rows)&&(x=n.data.rows);const ce=e=>e>=1e3&&e<=1999?"CUSTO DAS MERCADORIAS VENDIDAS":e>=2e3&&e<=2999?"DESPESAS OPERACIONAIS":e>=3e3&&e<=3999?"DESPESAS COM PESSOAL":e>=4001&&e<=4999?"ALUGUÃ‰IS E ARRENDAMENTOS":e>=5e3&&e<=5999?"IMPOSTOS, TAXAS E CONTRIBUIÃ‡Ã•ES":e>=6e3&&e<=6999?"DESPESAS GERAIS":e>=7e3&&e<=7999?"DESPESAS FINANCEIRAS":e>=8e3&&e<=8999?"OUTRAS DESPESAS OPERACIONAIS":e>=9e3&&e<=9999?"DESPESAS C/ VENDAS":"SEM CLASSIFICAÃ‡ÃƒO",b=Array.from(new Set((x||[]).map(e=>e.cd_despesaitem).filter(Boolean).filter(e=>!ya(e)))),he=Array.from(new Set((x||[]).map(e=>e.cd_fornecedor).filter(Boolean)));console.log("ðŸ” CÃ³digos Ãºnicos encontrados:",{totalItens:x.length,codigosDespesas:b.length,codigosFornecedores:he.length,amostraCodigosDespesas:b.slice(0,10),amostraCodigosFornecedores:he.slice(0,10)});let h=new Map,Pe=new Map;try{const[e,d]=await Promise.all([N.financial.despesa({cd_despesaitem:b}),N.financial.fornecedor({cd_fornecedor:he})]),u=Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e)?e:[],D=Array.isArray(d==null?void 0:d.data)?d.data:Array.isArray(d)?d:[];h=new Map(u.filter(f=>f&&f.cd_despesaitem!==void 0).map(f=>[f.cd_despesaitem,f])),Pe=new Map(D.filter(f=>f&&f.cd_fornecedor!==void 0).map(f=>[f.cd_fornecedor,f])),console.log("ðŸ“Š Resultados das buscas de nomes:",{despesasEncontradas:h.size,fornecedoresEncontrados:Pe.size,despesasNaoEncontradas:b.filter(f=>!h.has(f)),fornecedoresNaoEncontrados:he.filter(f=>!Pe.has(f))})}catch(e){console.warn("Falha ao enriquecer nomes de despesa/fornecedor:",e)}const Te=new Map;let ws=0;const j={semClassificacao:[],semDespesa:[],codigosDespesaInvalidos:[],codigosFornecedorInvalidos:[]};try{const e={cd_empresa:"1",cd_fornecedor:"31124",nr_duplicata:"854",nr_parcela:"3",cd_despesaitem:"6031"},d=(x||[]).filter(i=>String(i.cd_empresa)===e.cd_empresa&&String(i.cd_fornecedor)===e.cd_fornecedor&&String(i.nr_duplicata)===e.nr_duplicata&&String(i.nr_parcela)===e.nr_parcela&&String(i.cd_despesaitem)===e.cd_despesaitem),u=d.reduce((i,m)=>{const S=parseFloat(m.vl_rateio||0)||0,M=parseFloat(m.vl_duplicata||0)||0;return i+(S!==0?S:M)},0),D=(x||[]).filter(i=>String(i.cd_despesaitem)==="6031"),f=D.reduce((i,m)=>{const S=parseFloat(m.vl_rateio||0)||0,M=parseFloat(m.vl_duplicata||0)||0;return i+(S!==0?S:M)},0),Ne={},O={};for(const i of D){const m=parseFloat(i.vl_rateio||0)||0,S=parseFloat(i.vl_duplicata||0)||0,M=m!==0?m:S,ue=`${String(i.cd_empresa)}|${String(i.cd_fornecedor)}`,pe=`${String(i.nr_duplicata)}|${String(i.nr_parcela)}`;Ne[ue]=(Ne[ue]||0)+M,O[pe]=(O[pe]||0)+M}const Ja=Object.entries(Ne).map(([i,m])=>{const[S,M]=i.split("|");return{empresa:S,fornecedor:M,total:m}}).sort((i,m)=>Math.abs(m.total)-Math.abs(i.total)),T=Object.entries(O).map(([i,m])=>{const[S,M]=i.split("|");return{duplicata:S,parcela:M,total:m}}).sort((i,m)=>Math.abs(m.total)-Math.abs(i.total));console.log("ðŸ§ª DEBUG DRE - Registro chave e total por cÃ³digo 6031",{filtro:e,ocorrenciasRegistroChave:d.length,somaRegistroChave:u,ocorrenciasCodigo6031:D.length,somaCodigo6031:f,amostraRegistroChave:d.slice(0,3)}),console.table(Ja),console.table(T)}catch(e){console.warn("Falha ao gerar logs de diagnÃ³stico DRE:",e)}for(const e of x){const d=e.cd_ccusto??e.ccusto??e.cd_centrocusto??e.centrocusto??e.cc_custo??e.centro_custo??e.cd_ccusto_padrao,u=Number(d);if(!Number.isNaN(u)&&u===999)continue;const D=Number(e.cd_despesaitem)||0;if(ya(D))continue;const f=parseFloat(e.vl_rateio||0)||0,Ne=parseFloat(e.vl_duplicata||0)||0,O=f!==0?f:Ne;ws+=O;const T=Gs(D)||ce(D);T==="SEM CLASSIFICAÃ‡ÃƒO"&&j.semClassificacao.push({cd_despesaitem:e.cd_despesaitem,cd_fornecedor:e.cd_fornecedor,nr_duplicata:e.nr_duplicata,valor:O,motivo:`CÃ³digo ${D} nÃ£o estÃ¡ em nenhuma faixa (1000-1999, 2000-2999, etc.) nem nas exceÃ§Ãµes`}),(!e.cd_despesaitem||e.cd_despesaitem===""||e.cd_despesaitem===null)&&j.codigosDespesaInvalidos.push({cd_fornecedor:e.cd_fornecedor,nr_duplicata:e.nr_duplicata,valor:O,motivo:"cd_despesaitem estÃ¡ vazio, null ou undefined"}),Te.has(T)||Te.set(T,{id:`grp-${T}`,label:T,description:"",value:0,type:"despesa",children:[],_despesas:new Map});const i=Te.get(T),m=(((fe=h.get(e.cd_despesaitem))==null?void 0:fe.ds_despesaitem)||e.ds_despesaitem||"SEM DESPESA").toString().trim();m==="SEM DESPESA"&&j.semDespesa.push({cd_despesaitem:e.cd_despesaitem,cd_fornecedor:e.cd_fornecedor,nr_duplicata:e.nr_duplicata,valor:O,motivo:`CÃ³digo ${e.cd_despesaitem} nÃ£o encontrado na API /despesa nem tem ds_despesaitem no item original`,temNaAPI:h.has(e.cd_despesaitem),temNoItem:!!e.ds_despesaitem}),i._despesas.has(m)||i._despesas.set(m,{id:`desp-${T}-${m}`,label:m,description:"",value:0,type:"despesa",children:[],_forn:new Map,_fornCount:0});const S=i._despesas.get(m),M=Pe.get(e.cd_fornecedor),ue=((M==null?void 0:M.nm_fornecedor)||e.nm_fornecedor||e.cd_fornecedor||"Fornecedor").toString(),pe=String(e.cd_fornecedor||ue);S._forn.has(pe)||(S._forn.set(pe,{id:`forn-${pe}`,label:ue,description:[`Empresa: ${e.cd_empresa||"-"}`,`Fornecedor: ${e.cd_fornecedor||"-"}`].join(" | "),value:0,type:"despesa",children:[]}),S._fornCount+=1);const Ts=S._forn.get(pe);Ts.value+=-O,S.value+=-O,i.value+=-O}const na=Array.from(Te.values()).map(e=>{const d=Array.from(e._despesas.values()).map(u=>(u.description=`${u._fornCount} fornecedor(es) | Total: ${Number(Math.abs(u.value)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`,u.children=Array.from(u._forn.values()).sort((D,f)=>Math.abs(f.value)-Math.abs(D.value)),u));return d.sort((u,D)=>Math.abs(D.value)-Math.abs(u.value)),e.children=d,delete e._despesas,e});na.sort((e,d)=>Math.abs(d.value)-Math.abs(e.value));const Ua=na.filter(e=>e.label==="DESPESAS FINANCEIRAS"),ka=na.filter(e=>e.label!=="DESPESAS FINANCEIRAS"),Os=ka.reduce((e,d)=>e+Math.abs(d.value),0),Ps=Ua.reduce((e,d)=>e+Math.abs(d.value),0);if(xa(ka),ba(Os),os(Ua),rs(Ps),console.log("ðŸš¨ ANÃLISE DE PROBLEMAS - DRE Despesas Operacionais:",{totalItensProcessados:x.length,problemas:{semClassificacao:{quantidade:j.semClassificacao.length,itens:j.semClassificacao,resumo:j.semClassificacao.reduce((e,d)=>{const u=d.cd_despesaitem;return e[u]||(e[u]={count:0,valor:0}),e[u].count++,e[u].valor+=d.valor,e},{})},semDespesa:{quantidade:j.semDespesa.length,itens:j.semDespesa,resumo:j.semDespesa.reduce((e,d)=>{const u=d.cd_despesaitem;return e[u]||(e[u]={count:0,valor:0,temNaAPI:d.temNaAPI,temNoItem:d.temNoItem}),e[u].count++,e[u].valor+=d.valor,e},{})},codigosDespesaInvalidos:{quantidade:j.codigosDespesaInvalidos.length,itens:j.codigosDespesaInvalidos}},recomendacoes:{paraSemClassificacao:"Adicionar cÃ³digos nas exceÃ§Ãµes de categoriasDespesas.js ou criar nova faixa",paraSemDespesa:"Verificar se cÃ³digos existem na tabela de despesas ou adicionar ds_despesaitem nos dados originais",paraCodigosInvalidos:"Verificar integridade dos dados de cd_despesaitem"}}),j.semClassificacao.length>0||j.semDespesa.length>0){const e=j.semClassificacao.length+j.semDespesa.length;console.warn(`âš ï¸ ATENÃ‡ÃƒO: ${e} itens com problemas de classificaÃ§Ã£o encontrados. Verifique o console para detalhes.`)}}catch(c){console.error("Erro ao buscar/gerar Plano de Contas (AP EmissÃ£o):",c),xa([]),ba(0)}}catch(q){console.error("Erro ao buscar vendas brutas:",q),fa(`Erro ao carregar dados: ${q.message||"Erro desconhecido"}`)}finally{ma(!1),L("")}}},[N,l]),$a=t.useMemo(()=>{console.log("ðŸ”„ useMemo dreData - vendasBrutas:",Le,"devolucoes:",Ae,"descontos:",Ue,"totalDeducoes:",ga,"cmv:",ke,"receitaLiquida:",Je,"lucroBruto:",me,"icms:",Ca,"pis:",ja,"cofins:",_a,"totalImpostos:",Re);const s={id:"despesas-operacionais",label:"Despesas Operacionais",description:"Linhas de Contas a Pagar (EmissÃ£o), para classificaÃ§Ã£o posterior.",value:-xe,type:"despesa",children:ha},r={id:"despesas-financeiras",label:"Despesas Financeiras",description:"Encargos, juros e demais despesas financeiras.",value:-Ee,type:"despesa",children:Sa};return[{id:"vendas-bruta",label:"Receitas Brutas",description:"Quanto vocÃª vendeu no perÃ­odo (sem tirar nada ainda).",value:Le,type:"receita",children:[{id:"varejo",label:"Varejo",description:"Vendas do canal Varejo",value:A.totalBruto+A.totalDevolucoes,type:"receita"},{id:"multimarcas",label:"Multimarcas",description:"Vendas do canal Multimarcas",value:E.totalBruto+E.totalDevolucoes,type:"receita"},{id:"revenda",label:"Revenda",description:"Vendas do canal Revenda",value:B.totalBruto+B.totalDevolucoes,type:"receita"},{id:"franquias",label:"Franquias",description:"Vendas do canal Franquias",value:R.totalBruto+R.totalDevolucoes,type:"receita"}]},{id:"deducoes-vendas",label:"DeduÃ§Ãµes sobre Vendas",description:"DevoluÃ§Ãµes, descontos concedidos e impostos sobre vendas.",value:-(Ae+Ue+Re),type:"deducao",children:[{id:"devolucoes",label:"DevoluÃ§Ãµes",description:"Clientes devolveram mercadorias",value:-Ae,type:"deducao",children:[{id:"devolucoes-varejo",label:"Varejo",description:"DevoluÃ§Ãµes do canal Varejo",value:-A.totalDevolucoes,type:"deducao"},{id:"devolucoes-multimarcas",label:"Multimarcas",description:"DevoluÃ§Ãµes do canal Multimarcas",value:-E.totalDevolucoes,type:"deducao"},{id:"devolucoes-revenda",label:"Revenda",description:"DevoluÃ§Ãµes do canal Revenda",value:-B.totalDevolucoes,type:"deducao"},{id:"devolucoes-franquias",label:"Franquias",description:"DevoluÃ§Ãµes do canal Franquias",value:-R.totalDevolucoes,type:"deducao"}]},{id:"descontos",label:"Descontos Concedidos",description:"Descontos dados aos clientes",value:-(A.totalBruto-A.totalDevolucoes-(A.totalLiquido-A.totalDevolucoes)+(E.totalBruto-E.totalDevolucoes-(E.totalLiquido-E.totalDevolucoes))+(B.totalBruto-B.totalDevolucoes-(B.totalLiquido-B.totalDevolucoes))+(R.totalBruto-R.totalDevolucoes-(R.totalLiquido-R.totalDevolucoes))),type:"deducao",children:[{id:"descontos-varejo",label:"Varejo",description:"Descontos do canal Varejo",value:-(A.totalBruto-A.totalDevolucoes-(A.totalLiquido-A.totalDevolucoes)),type:"deducao"},{id:"descontos-multimarcas",label:"Multimarcas",description:"Descontos do canal Multimarcas",value:-(E.totalBruto-E.totalDevolucoes-(E.totalLiquido-E.totalDevolucoes)),type:"deducao"},{id:"descontos-revenda",label:"Revenda",description:"Descontos do canal Revenda",value:-(B.totalBruto-B.totalDevolucoes-(B.totalLiquido-B.totalDevolucoes)),type:"deducao"},{id:"descontos-franquias",label:"Franquias",description:"Descontos do canal Franquias",value:-(R.totalBruto-R.totalDevolucoes-(R.totalLiquido-R.totalDevolucoes)),type:"deducao"}]},{id:"impostos-vendas",label:"Impostos sobre Vendas",description:"ICMS, PIS, COFINS e outros impostos sobre vendas.",value:-Re,type:"deducao",children:[{id:"impostos-varejo",label:"Varejo",description:"Impostos do canal Varejo",value:-(ie.icms+ie.pis+ie.cofins),type:"deducao",children:[{id:"icms-varejo",label:"ICMS",description:"ICMS do canal Varejo",value:-ie.icms,type:"deducao"},{id:"pis-varejo",label:"PIS",description:"PIS do canal Varejo",value:-ie.pis,type:"deducao"},{id:"cofins-varejo",label:"COFINS",description:"COFINS do canal Varejo",value:-ie.cofins,type:"deducao"}]},{id:"impostos-multimarcas",label:"Multimarcas",description:"Impostos do canal Multimarcas",value:-(de.icms+de.pis+de.cofins),type:"deducao",children:[{id:"icms-multimarcas",label:"ICMS",description:"ICMS do canal Multimarcas",value:-de.icms,type:"deducao"},{id:"pis-multimarcas",label:"PIS",description:"PIS do canal Multimarcas",value:-de.pis,type:"deducao"},{id:"cofins-multimarcas",label:"COFINS",description:"COFINS do canal Multimarcas",value:-de.cofins,type:"deducao"}]},{id:"impostos-revenda",label:"Revenda",description:"Impostos do canal Revenda",value:-(ne.icms+ne.pis+ne.cofins),type:"deducao",children:[{id:"icms-revenda",label:"ICMS",description:"ICMS do canal Revenda",value:-ne.icms,type:"deducao"},{id:"pis-revenda",label:"PIS",description:"PIS do canal Revenda",value:-ne.pis,type:"deducao"},{id:"cofins-revenda",label:"COFINS",description:"COFINS do canal Revenda",value:-ne.cofins,type:"deducao"}]},{id:"impostos-franquias",label:"Franquias",description:"Impostos do canal Franquias",value:-(le.icms+le.pis+le.cofins),type:"deducao",children:[{id:"icms-franquias",label:"ICMS",description:"ICMS do canal Franquias",value:-le.icms,type:"deducao"},{id:"pis-franquias",label:"PIS",description:"PIS do canal Franquias",value:-le.pis,type:"deducao"},{id:"cofins-franquias",label:"COFINS",description:"COFINS do canal Franquias",value:-le.cofins,type:"deducao"}]}]}]},{id:"receita-liquida",label:"Receita LÃ­quida de Vendas",description:"Ã‰ o que realmente ficou das vendas.",value:Je,type:"resultado",children:[{id:"receita-liquida-varejo",label:"Varejo",description:"Receita lÃ­quida do canal Varejo",value:qa,type:"resultado"},{id:"receita-liquida-multimarcas",label:"Multimarcas",description:"Receita lÃ­quida do canal Multimarcas",value:Da,type:"resultado"},{id:"receita-liquida-revenda",label:"Revenda",description:"Receita lÃ­quida do canal Revenda",value:Na,type:"resultado"},{id:"receita-liquida-franquias",label:"Franquias",description:"Receita lÃ­quida do canal Franquias",value:Ma,type:"resultado"}]},{id:"cmv",label:"Custos da Mercadoria Vendida (CMV)",description:"Quanto custou comprar ou produzir o que vocÃª vendeu (matÃ©ria-prima, mercadorias para revenda, mÃ£o de obra da produÃ§Ã£o).",value:-ke,type:"custo",children:[{id:"cmv-varejo",label:"Varejo",description:"CMV do canal Varejo",value:-La,type:"custo"},{id:"cmv-multimarcas",label:"Multimarcas",description:"CMV do canal Multimarcas",value:-Aa,type:"custo"},{id:"cmv-revenda",label:"Revenda",description:"CMV do canal Revenda",value:-Ra,type:"custo"},{id:"cmv-franquias",label:"Franquias",description:"CMV do canal Franquias",value:-Ea,type:"custo"}]},{id:"lucro-bruto",label:"Lucro Bruto",description:"Receita LÃ­quida â€“ CMV",value:me,type:"resultado",children:[{id:"lucro-bruto-varejo",label:"Varejo",description:"Lucro bruto do canal Varejo",value:Ba,type:"resultado"},{id:"lucro-bruto-multimarcas",label:"Multimarcas",description:"Lucro bruto do canal Multimarcas",value:Fa,type:"resultado"},{id:"lucro-bruto-revenda",label:"Revenda",description:"Lucro bruto do canal Revenda",value:Va,type:"resultado"},{id:"lucro-bruto-franquias",label:"Franquias",description:"Lucro bruto do canal Franquias",value:Ia,type:"resultado"}]},s,{id:"resultado-operacional",label:"Resultado Operacional",description:"Lucro Bruto - Despesas Operacionais",value:me-xe,type:"resultado",children:[]},r,{id:"lucro-antes-impostos",label:"Lucro Antes do IR/CSLL",description:"Resultado antes dos impostos sobre o lucro.",value:me-xe-Ee,type:"resultado",children:[]},{id:"impostos-lucro",label:"Impostos sobre o Lucro (IR/CSLL)",description:"Se a empresa paga esse tipo de imposto.",value:0,type:"imposto",children:[{id:"irpj",label:"IRPJ",description:"Imposto de Renda Pessoa JurÃ­dica",value:0,type:"imposto"},{id:"csll",label:"CSLL",description:"ContribuiÃ§Ã£o Social sobre o Lucro LÃ­quido",value:0,type:"imposto"}]},{id:"lucro-liquido",label:"Lucro LÃ­quido do ExercÃ­cio",description:"Resultado Operacional - Despesas Financeiras - Impostos sobre o Lucro",value:me-xe-Ee-0,type:"resultado-final",children:[]}]},[Le,Ae,Ue,ga,ke,Je,me,Ca,ja,_a,Re,xe,ha,Sa,A,E,R,B,ie,de,le,ne,qa,Da,Ma,Na,La,Aa,Ea,Ra,Ba,Fa,Ia,Va,Ee]),Ye=s=>{const r=new Set(Fe);r.has(s)?r.delete(s):r.add(s),Ge(r)},Bs=()=>{if(Ie)Ge(new Set);else{const s=new Set,r=["Receitas Brutas","Receita LÃ­quida de Vendas","Lucro Bruto","Resultado Operacional","Lucro Antes do IR/CSLL","Lucro LÃ­quido do ExercÃ­cio"];$a.forEach(p=>{r.includes(p.label)||(s.add(p.label),p.children&&p.children.forEach(v=>{s.add(`${p.label}|${v.label}`),v.children&&v.children.forEach(y=>{s.add(`${p.label}|${v.label}|${y.label}`)})}))}),Ge(s)}Es(!Ie)},Ve=s=>{const r=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Math.abs(s));return s<0?`-${r}`:r};return a.jsxs("div",{className:"p-6",children:[a.jsx(zs,{title:"DRE - Demonstrativo de Resultado do ExercÃ­cio",subtitle:"AnÃ¡lise detalhada dos resultados financeiros do perÃ­odo",icon:Ga}),a.jsxs("div",{className:"bg-white rounded-lg shadow p-3 mb-4 border border-gray-200",children:[a.jsxs("div",{className:"mb-6",children:[a.jsxs("span",{className:"text-lg font-bold text-[#000638] flex items-center gap-1",children:[a.jsx(Js,{size:18,weight:"bold"}),"Filtros"]}),a.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"Selecione o perÃ­odo para anÃ¡lise"})]}),a.jsx("div",{className:"mb-3",children:a.jsx("div",{className:"flex flex-wrap gap-1",children:["ANO","JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"].map(s=>a.jsx("button",{type:"button",onClick:()=>As(s),className:`px-3 py-1 text-xs font-medium rounded-md transition-colors ${Ms===s?"bg-[#000638] text-white":"bg-white text-gray-600 hover:bg-gray-100 border border-gray-300"}`,children:s},s))})}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-xs font-semibold mb-1",children:"PerÃ­odo Inicial"}),a.jsx("input",{type:"date",className:"border rounded px-2 py-1.5 w-full text-xs",value:l.dt_inicio,onChange:s=>Be(r=>({...r,dt_inicio:s.target.value}))})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"PerÃ­odo Final"}),a.jsx("input",{type:"date",className:"border rounded px-2 py-1.5 w-full text-xs",value:l.dt_fim,onChange:s=>Be(r=>({...r,dt_fim:s.target.value}))})]}),a.jsx("div",{className:"flex items-center",children:a.jsx("button",{className:"bg-[#000638] text-white text-xs px-3 py-2 rounded hover:bg-[#fe0000]",onClick:Rs,disabled:ze,children:ze?"Carregando...":"Buscar Dados"})})]}),va&&a.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md",children:a.jsx("p",{className:"text-sm text-red-700",children:va})})]}),a.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[a.jsxs("div",{className:"bg-gray-50 px-4 py-3 border-b border-gray-200",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Demonstrativo de Resultado do ExercÃ­cio"}),a.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["PerÃ­odo:"," ",(()=>{const s=p=>{if(!p)return null;try{const[v,y,g]=p.split("-").map(F=>parseInt(F,10));return!v||!y||!g?null:new Date(v,y-1,g)}catch{return null}},r=p=>{const v=s(p);if(!v)return"";const y=String(v.getDate()).padStart(2,"0"),g=String(v.getMonth()+1).padStart(2,"0"),F=String(v.getFullYear());return`${y}/${g}/${F}`};return l.dt_inicio&&l.dt_fim?`${r(l.dt_inicio)} a ${r(l.dt_fim)}`:"Selecione um perÃ­odo"})()]})]}),ze?a.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[a.jsx(Us,{size:"lg",text:_||"Carregando dados do DRE..."}),_&&a.jsxs("div",{className:"mt-4 w-full max-w-md",children:[a.jsx("div",{className:"bg-gray-200 rounded-full h-2",children:a.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:_.includes("Varejo")?"20%":_.includes("Multimarcas")?"40%":_.includes("Franquia")?"60%":_.includes("Revenda")?"80%":_.includes("impostos")?"95%":_.includes("Processando")?"100%":"0%"}})}),a.jsxs("div",{className:"text-center mt-2 text-sm text-gray-600",children:[_.includes("Varejo")&&"1/5 - Varejo",_.includes("Multimarcas")&&"2/5 - Multimarcas",_.includes("Franquia")&&"3/5 - Franquia",_.includes("Revenda")&&"4/5 - Revenda",_.includes("impostos")&&"5/5 - Impostos",_.includes("Processando")&&"Finalizando..."]})]})]}):Le>0?a.jsx(a.Fragment,{children:a.jsxs("div",{className:"space-y-2 flex justify-center items-center flex-col",children:[a.jsx("div",{className:"flex justify-between items-center",children:a.jsx("button",{onClick:Bs,className:"text-xs text-gray-500 hover:text-gray-700 px-0.5 py-0.5 rounded transition-colors flex items-center gap-1",title:Ie?"Colapsar todos os tÃ³picos":"Expandir todos os tÃ³picos",children:Ie?a.jsxs(a.Fragment,{children:[a.jsx("span",{children:"âˆ’"}),a.jsx("span",{children:"Colapsar tudo"})]}):a.jsxs(a.Fragment,{children:[a.jsx("span",{children:"+"}),a.jsx("span",{children:"Expandir tudo"})]})})}),$a.map((s,r)=>{const p=Fe.has(s.label),y=[].includes(s.label);return a.jsxs("div",{className:`w-1/2 ${y?"bg-blue-50 rounded-lg":"border border-gray-200 rounded-lg overflow-hidden"}`,children:[a.jsx("div",{className:`${y?"bg-blue-50 cursor-default":"bg-gray-50 hover:bg-gray-100 cursor-pointer"} transition-colors px-2 py-1.5 flex items-center justify-between`,onClick:y?void 0:()=>Ye(s.label),children:a.jsxs("div",{className:"flex items-center space-x-2",children:[!y&&(p?a.jsx(ua,{size:10,className:"text-gray-600"}):a.jsx(pa,{size:10,className:"text-gray-600"})),a.jsxs("div",{children:[a.jsx("h3",{className:"font-medium text-xs text-gray-800",children:s.label}),a.jsx("div",{className:"flex gap-96 items-center justify-between space-x-32 text-xs text-gray-600",children:a.jsx("span",{className:`font-medium text-xs ${s.value>=0?"text-green-600":"text-red-600"}`,children:Ve(Math.abs(s.value))})})]})]})}),p&&s.children&&s.children.length>0&&a.jsx("div",{className:"bg-white border-t border-gray-100",children:s.children.map((g,F)=>{const P=`${s.label}|${g.label}`,z=Fe.has(P),ve=g.children&&g.children.length>0;return a.jsxs("div",{className:"border-b border-gray-100 last:border-b-0",children:[a.jsx("div",{className:`bg-gray-25 hover:bg-gray-50 transition-colors px-4 py-1.5 flex items-center justify-between ${ve?"cursor-pointer":"cursor-default"}`,onClick:ve?()=>Ye(P):void 0,children:a.jsxs("div",{className:"flex items-center space-x-2",children:[ve&&(z?a.jsx(ua,{size:10,className:"text-gray-500"}):a.jsx(pa,{size:10,className:"text-gray-500"})),a.jsxs("div",{children:[a.jsx("h4",{className:"font-medium text-xs text-gray-700",children:g.label}),a.jsx("div",{className:"flex items-center space-x-3 text-xs text-gray-500",children:a.jsx("span",{className:`font-medium ${g.value>=0?"text-green-500":"text-red-500"}`,children:Ve(Math.abs(g.value))})})]})]})}),z&&g.children&&g.children.length>0&&a.jsx("div",{className:"bg-white border-t border-gray-50",children:g.children.map((C,be)=>{const Se=`${s.label}|${g.label}|${C.label}`,ye=Fe.has(Se),fe=C.children&&C.children.length>0;return a.jsxs("div",{className:"border-b border-gray-50 last:border-b-0",children:[a.jsx("div",{className:`bg-gray-25 hover:bg-gray-50 transition-colors px-6 py-1.5 flex items-center justify-between ${fe?"cursor-pointer":"cursor-default"}`,onClick:fe?()=>Ye(Se):void 0,children:a.jsxs("div",{className:"flex items-center space-x-2",children:[fe&&(ye?a.jsx(ua,{size:10,className:"text-gray-400"}):a.jsx(pa,{size:10,className:"text-gray-400"})),a.jsxs("div",{children:[a.jsx("h5",{className:"font-medium text-xs text-gray-600",children:C.label}),a.jsxs("div",{className:"flex items-center space-x-3 text-xs text-gray-400",children:[C.description&&a.jsx("span",{className:"text-gray-400",children:C.description}),a.jsx("span",{className:`font-medium ${C.value>=0?"text-green-400":"text-red-400"}`,children:Ve(Math.abs(C.value))})]})]})]})}),ye&&C.children&&C.children.length>0&&a.jsx("div",{className:"bg-white border-t border-gray-50",children:C.children.map((q,U)=>a.jsx("div",{className:"border-b border-gray-50 last:border-b-0",children:a.jsx("div",{className:"bg-gray-25 hover:bg-gray-50 cursor-default transition-colors px-8 py-1.5 flex items-center justify-between",children:a.jsx("div",{className:"flex items-center space-x-2",children:a.jsxs("div",{children:[a.jsx("h6",{className:"font-medium text-xs text-gray-500",children:q.label}),a.jsxs("div",{className:"flex items-center space-x-3 text-xs text-gray-300",children:[q.description&&a.jsx("span",{className:"text-gray-400",children:q.description}),a.jsx("span",{className:`font-medium ${q.value>=0?"text-green-300":"text-red-300"}`,children:Ve(Math.abs(q.value))})]})]})})})},`subsubsubitem-${r}-${F}-${be}-${U}-${q.id}`))})]},`subsubitem-${r}-${F}-${be}-${C.id}`)})})]},`subitem-${r}-${F}-${g.id}`)})})]},`modulo-${r}-${s.id}`)})]})}):a.jsx("div",{className:"flex flex-col items-center justify-center py-12 px-4",children:a.jsxs("div",{className:"text-center",children:[a.jsx(Ga,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Nenhum dado carregado"})]})})]})]})};export{et as default};
