import{f as l}from"./index-a2563983.js";const i="retorno_bancario",g=async(a,e,c,o,s)=>{try{const{data:n,error:r}=await l.from(i).select("id").eq("nome_arquivo",a).eq("valor",e).eq("banco_nome",c).eq("banco_codigo",o).eq("data_geracao",s).single();if(r){if(r.code==="PGRST116")return!1;if(r.code==="42501")return console.warn("Erro de permiss√£o RLS - assumindo que arquivo n√£o existe:",r.message),!1;throw console.error("Erro ao verificar arquivo existente:",r),r}return!!n}catch(n){return console.error("Erro na verifica√ß√£o de arquivo existente:",n),!1}},p=async a=>{var e,c,o,s,n;try{if(await g(a.nomeArquivo,a.valor,a.banco.nome,a.banco.codigo,a.dataGeracao))return{success:!1,message:`Arquivo "${a.nomeArquivo}" j√° foi processado anteriormente`,duplicate:!0};const t={nome_arquivo:a.nomeArquivo,data_upload:a.dataUpload,valor:a.valor,banco_nome:a.banco.nome,banco_codigo:a.banco.codigo,banco_layout:a.banco.layout,agencia:a.agencia,conta:a.conta,saldo_formatado:a.saldoFormatado,data_processamento:new Date().toISOString(),data_geracao:a.dataGeracao,operacao_tipo:((e=a.operacao)==null?void 0:e.tipo)||null,operacao_descricao:((c=a.operacao)==null?void 0:c.descricao)||null,operacao_sinal:((o=a.operacao)==null?void 0:o.sinal)||null,operacao_is_positive:((s=a.operacao)==null?void 0:s.isPositive)||null,operacao_valor_absoluto:((n=a.operacao)==null?void 0:n.valorAbsoluto)||null,created_at:new Date().toISOString()},{data:u,error:m}=await l.from(i).insert([t]).select().single();if(m){if(m.code==="42501")throw console.error("Erro de permiss√£o RLS - verifique se a tabela est√° configurada corretamente:",m.message),new Error("Erro de permiss√£o no banco de dados. Verifique a configura√ß√£o da tabela.");if(m.code==="23505")return console.warn("Arquivo duplicado detectado pelo banco:",m.message),{success:!1,message:`Arquivo "${a.nomeArquivo}" com valor ${a.valor} do banco ${a.banco.nome} e data de gera√ß√£o ${new Date(a.dataGeracao).toLocaleString("pt-BR")} j√° foi processado anteriormente`,duplicate:!0};throw console.error("Erro ao salvar retorno banc√°rio:",m),m}return{success:!0,message:"Arquivo salvo com sucesso no banco de dados",data:u}}catch(r){return console.error("Erro ao salvar retorno banc√°rio:",r),{success:!1,message:"Erro ao salvar no banco de dados: "+r.message,error:r}}},f=async(a={})=>{try{let e=l.from(i).select("*").neq("nome_arquivo","saldo_manual_deletado").neq("nome_arquivo","limite_cheque_especial").order("data_geracao",{ascending:!1});a.contas&&a.contas.length>0&&(e=e.in("conta",a.contas)),a.dataInicio&&(e=e.gte("data_geracao",a.dataInicio+"T00:00:00")),a.dataFim&&(e=e.lte("data_geracao",a.dataFim+"T23:59:59")),a.banco&&(e=e.eq("banco_nome",a.banco)),Object.keys(a).length===0&&(e=l.from(i).select("*").neq("nome_arquivo","saldo_manual_deletado").neq("nome_arquivo","limite_cheque_especial").order("data_geracao",{ascending:!1}));const{data:c,error:o}=await e;if(console.log("üîç Dados retornados da query:",(c==null?void 0:c.length)||0,"registros"),console.log("üîç Exemplo de registro:",c==null?void 0:c[0]),o)throw console.error("Erro ao buscar saldos por conta:",o),o;const s={};c.forEach(r=>{const t=r.conta;s[t]||(s[t]={numero:t,nome:`Conta ${t}`,saldo:0,ultimaAtualizacao:null,banco:r.banco_nome,agencia:r.agencia,operacao:{tipo:r.operacao_tipo,descricao:r.operacao_descricao,sinal:r.operacao_sinal,isPositive:r.operacao_is_positive,valorAbsoluto:r.operacao_valor_absoluto},registros:[]});const u=new Date(r.data_geracao);(!s[t].ultimaAtualizacao||u>s[t].ultimaAtualizacao)&&(s[t].saldo=parseFloat(r.valor),s[t].ultimaAtualizacao=u,s[t].banco=r.banco_nome,s[t].agencia=r.agencia),s[t].registros.push(r)});const n=Object.values(s).sort((r,t)=>t.saldo-r.saldo);return{success:!0,data:n,totalRegistros:c.length,totalContas:n.length}}catch(e){return console.error("Erro ao buscar saldos por conta:",e),{success:!1,message:"Erro ao buscar dados: "+e.message,error:e}}},v=async(a,e,c)=>{try{console.log(`üîç Buscando limite para banco/agencia/conta: ${a} / ${e} / ${c}`);const{data:o,error:s}=await l.from(i).select("chq_especial, conta, agencia").eq("banco_nome",a).eq("agencia",e).eq("conta",c).eq("nome_arquivo","limite_cheque_especial").not("chq_especial","is",null).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(s){if(s.code==="PGRST116")return{success:!0,data:null};throw console.error("Erro ao buscar limite de cheque especial:",s),s}return{success:!0,data:(o==null?void 0:o.chq_especial)||null,conta:(o==null?void 0:o.conta)||null,agencia:(o==null?void 0:o.agencia)||null}}catch(o){return console.error("Erro ao buscar limite de cheque especial:",o),{success:!1,message:"Erro ao buscar limite: "+o.message,error:o}}},q=async a=>{try{const e={nome_arquivo:a.nome_arquivo,data_upload:a.data_upload,valor:a.valor,banco_nome:a.banco_nome,banco_codigo:a.banco_codigo,banco_layout:a.banco_layout,agencia:a.agencia,conta:a.conta,saldo_formatado:a.saldo_formatado,data_processamento:a.data_processamento,data_geracao:a.data_geracao,operacao_tipo:a.operacao_tipo,operacao_descricao:a.operacao_descricao,operacao_sinal:a.operacao_sinal,operacao_is_positive:a.operacao_is_positive,operacao_valor_absoluto:a.operacao_valor_absoluto,chq_especial:a.chq_especial,usuario_inseriu:a.usuario_inseriu,created_at:a.created_at},{data:c,error:o}=await l.from(i).insert([e]).select().single();if(o){if(o.code==="42501")throw console.error("Erro de permiss√£o RLS - verifique se a tabela est√° configurada corretamente:",o.message),new Error("Erro de permiss√£o no banco de dados. Verifique a configura√ß√£o da tabela.");if(o.code==="23505")return console.warn("Saldo duplicado detectado pelo banco:",o.message),{success:!1,message:`Saldo para ${a.banco_nome} - Ag√™ncia ${a.agencia} - Conta ${a.conta} j√° foi inserido anteriormente`,duplicate:!0};throw console.error("Erro ao salvar saldo manual:",o),o}return{success:!0,message:"Saldo manual salvo com sucesso no banco de dados",data:c}}catch(e){return console.error("Erro ao salvar saldo manual:",e),{success:!1,message:"Erro ao salvar no banco de dados: "+e.message,error:e}}},b=async a=>{try{console.log("üîç Tentando remover saldo manual com ID:",a);const{data:e,error:c}=await l.from(i).select("*").eq("id",a).single();if(console.log("üîç Verifica√ß√£o do registro:",{checkData:e,checkError:c}),c)return console.error("‚ùå Erro ao verificar registro:",c),{success:!1,message:"Registro n√£o encontrado: "+c.message};if(!e||e.nome_arquivo!=="saldo_manual")return console.error("‚ùå Registro n√£o √© um saldo manual:",e),{success:!1,message:"Registro n√£o √© um saldo manual"};console.log("‚úÖ Registro encontrado e √© um saldo manual. Tentando excluir...");const{data:o,error:s}=await l.from(i).delete().eq("id",a).select();if(console.log("üìä Resultado da query de exclus√£o:",{deleteData:o,deleteError:s}),s){if(console.error("‚ùå Erro ao remover saldo manual:",s),s.code==="42501"){console.log("üîÑ Tentando abordagem alternativa para exclus√£o...");const{data:n,error:r}=await l.from(i).update({nome_arquivo:"saldo_manual_deletado",data_processamento:new Date().toISOString()}).eq("id",a).eq("nome_arquivo","saldo_manual").select();return console.log("üìä Resultado da marca√ß√£o como deletado:",{updateData:n,updateError:r}),r?(console.error("‚ùå Erro ao marcar como deletado:",r),{success:!1,message:"Erro de permiss√£o: "+s.message+". Erro ao marcar como deletado: "+r.message}):{success:!0,message:"Saldo manual marcado como deletado (n√£o foi poss√≠vel excluir fisicamente)",data:n}}throw s}return console.log("‚úÖ Saldo manual removido com sucesso. Registros afetados:",(o==null?void 0:o.length)||0),{success:!0,message:"Saldo manual removido com sucesso",data:o}}catch(e){return console.error("‚ùå Erro ao remover saldo manual:",e),{success:!1,message:"Erro ao remover saldo: "+e.message,error:e}}},h=async(a,e,c,o)=>{try{const{data:s,error:n}=await l.from(i).select("*").eq("banco_nome",a).eq("agencia",o).eq("conta",c).eq("nome_arquivo","limite_cheque_especial").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(n&&n.code!=="PGRST116")throw console.error("Erro ao buscar dados do banco/conta:",n),n;let r;if(s){const{data:t,error:u}=await l.from(i).update({chq_especial:e,data_processamento:new Date().toISOString()}).eq("id",s.id).select().single();if(u)throw console.error("Erro ao atualizar limite de cheque especial:",u),u;r=t}else{const t=new Date().toISOString(),u={nome_arquivo:"limite_cheque_especial",data_upload:t,valor:0,banco_nome:a,banco_codigo:"000",banco_layout:"limite",agencia:o,conta:c,chq_especial:e,saldo_formatado:0 .toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),data_processamento:t,data_geracao:t,created_at:t},{data:m,error:d}=await l.from(i).insert([u]).select().single();if(d)throw console.error("Erro ao criar limite de cheque especial:",d),d;r=m}return{success:!0,data:r,message:s?"Limite de cheque especial atualizado com sucesso":"Limite de cheque especial criado com sucesso"}}catch(s){return console.error("Erro ao salvar limite de cheque especial:",s),{success:!1,message:"Erro ao salvar limite: "+s.message,error:s}}},E=async a=>{try{console.log("üî® For√ßando remo√ß√£o de saldo manual com ID:",a);try{const{data:e,error:c}=await l.from(i).delete().eq("id",a).select();if(!c&&e&&e.length>0)return console.log("‚úÖ Exclus√£o direta bem-sucedida"),{success:!0,message:"Saldo manual removido com sucesso",data:e}}catch(e){console.log("‚ùå Exclus√£o direta falhou:",e.message)}try{const{data:e,error:c}=await l.from(i).update({nome_arquivo:"saldo_manual_deletado",data_processamento:new Date().toISOString()}).eq("id",a).select();if(!c&&e&&e.length>0)return console.log("‚úÖ Marca√ß√£o como deletado bem-sucedida"),{success:!0,message:"Saldo manual marcado como deletado",data:e}}catch(e){console.log("‚ùå Marca√ß√£o como deletado falhou:",e.message)}try{const{data:e,error:c}=await l.rpc("remover_saldo_manual",{saldo_id:a});if(!c&&e)return console.log("‚úÖ Remo√ß√£o via RPC bem-sucedida"),{success:!0,message:"Saldo manual removido via RPC",data:e}}catch(e){console.log("‚ùå Remo√ß√£o via RPC falhou:",e.message)}return{success:!1,message:"N√£o foi poss√≠vel remover o saldo manual. Verifique as permiss√µes do banco de dados."}}catch(e){return console.error("‚ùå Erro ao for√ßar remo√ß√£o de saldo manual:",e),{success:!1,message:"Erro ao for√ßar remo√ß√£o: "+e.message,error:e}}};export{q as a,v as b,f as c,p as d,E as f,b as r,h as s};
